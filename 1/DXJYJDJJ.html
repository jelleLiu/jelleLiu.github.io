

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>我的数字孪生项目</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
  <link type="text/css" rel="stylesheet" href="css/main.css" />
  <link type="text/css" rel="stylesheet" href="css/ui.css" />
  <link type="text/css" rel="stylesheet" href="css/bootstrap.css" />
  <link type="text/css" rel="stylesheet" href="css/daterangepicker.css" />
  <link type="text/css" rel="stylesheet" href="css/edit.css" />
  <link type="text/css" rel="stylesheet" href="FontAwesome/css/font-awesome.css" />
  <link type="text/css" rel="stylesheet" href="css/framebox.css" />
  <link type="text/css" rel="stylesheet" href="css/drag.css" />
  <link type="text/css" rel="stylesheet" href="css/plugins/colorpicker/css/bootstrap-colorpicker.min.css" />

  <script type="text/javascript" src="dist/echarts.js"></script>
  <script type="text/javascript" src="dist/tween.umd.js"></script>
  <script type="text/javascript" src="js/jquery-3.6.0.min.js"></script>
  <script type="text/javascript" src="js/jqueryhelper.js"></script>
  <script type="text/javascript" src="js/bootstrap.bundle.min.js"></script>
  <script type="text/javascript" src="js/animationtools.js"></script>
  <script type="text/javascript" src="js/toolbar.js"></script>
  <script type="text/javascript" src="js/popupform.js"></script>
  <script type="text/javascript" src="js/moment.min.js"></script>
  <script type="text/javascript" src="js/daterangepicker.js"></script>
  <script type="text/javascript" src="js/plugins/colorpicker/bootstrap-colorpicker.min.js"></script>
  <script type="text/javascript" src="js/plugins/layer/layer.min.js"></script>

  <style type="text/css">
    body {
      background-color: #000;
      width: 100%;
      overflow: hidden;
    }

    .divbox {
      cursor: move;
      position: absolute;
      /*background-color: #FFF;*/
      /*border: 1px solid #CCCCCC;*/
      /*-webkit-box-shadow: 5px 5px 10px #ccc;
      -moz-box-shadow: 5px 5px 10px #ccc;
      box-shadow: 5px 5px 10px #ccc;*/
    }

    .coor {
      width: 10px;
      height: 10px;
      overflow: hidden;
      cursor: se-resize;
      position: absolute;
      right: 0;
      bottom: 0;
      background-color: #09C;
    }

    .boxPlace {
      display: inline-block;
      word-wrap: break-word;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .jstree-open > .jstree-anchor > .fa-folder:before {
      content: "\f07c";
    }

    .jstree-default .jstree-icon.none {
      width: 0;
    }

    #bg {
      width: 10px;
      height: 10px;
      position: absolute;
      top: 50px;
      left: 10px;
      color: #333333;
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-size: cover;
      z-index: 1;
    }

    a:hover {
      background-color: #aaa;
    }


    /* 数字增减控件 */

    .spinner {
      width: 70px;
    }

      .spinner input {
        text-align: right;
      }

    .input-group-btn-vertical {
      position: relative;
      white-space: nowrap;
      width: 1%;
      vertical-align: middle;
      display: table-cell;
    }

      .input-group-btn-vertical > .btn {
        display: block;
        float: none;
        width: 100%;
        max-width: 100%;
        padding: 9px 16px;
        margin-left: 1px;
        position: relative;
        border-radius: 0;
        background-color: aliceblue;
      }

        .input-group-btn-vertical > .btn:first-child {
          border-top-right-radius: 4px;
        }

        .input-group-btn-vertical > .btn:last-child {
          margin-top: -2px;
          border-bottom-right-radius: 4px;
        }

      .input-group-btn-vertical i {
        position: absolute;
        top: 0;
        left: 12px;
      }

    #PartCrumbs span {
      color: slateblue;
      text-decoration: underline;
      cursor: pointer;
    }

      #PartCrumbs span.s {
        color: blue;
        font-weight: bold;
      }
  </style>
</head>
<body style="overflow-y: hidden; overflow-x: hidden;" onselectstart="return false;">

    <!-- 背景：可视化图表 -->
    <div id="bg">
      <span id="bgInfo" style="display: none;"></span>
    </div>

    <!-- 可视化图表的标题 -->
    <div id="TitleBox" style="top: 5px; width: 80vw; margin: 60px auto; text-align: center; font-size: 2.5vw; font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif; color: #114; text-shadow: -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff, 0px 2px 2px rgba(0,0,0,0.6);">
      <center>
        <div id="VisualTitle" style="background-image: url('/img/Title01.png'); width: 500px; background-position: center bottom; background-repeat: no-repeat; height: 150px; cursor: pointer; display: none;"></div>
      </center>
    </div>

    <!-- 功能层 -->
    <div id="logo" style="position: absolute; top: 0px; left: 0px; width: 100%; height: 100%; background-color: rgb(209 81 13 / 1); z-index: 1000;">
      <div style="position: absolute; width: 150px; height: 180px; left: 50%; top: 50%; margin: -90px 0 0 -75px; text-align: center;">
        <img src="img/Logo.png" alt="logo" /><br />
        <h5>正在加载……</h5>
      </div>
    </div>

    <!-- 演示等待 -->
    <div id="WaitTips" style="position: absolute; width: 500px; left: calc(50% - 250px); bottom: 80px; height: 60px; z-index: 999; text-align: center; display: none;">
      <div class="btn-group">
        <button id="WaitTipsBtn" type="button" class="btn btn-warning" style="width: 300px; height: 60px;"><span class="spinner-grow spinner-grow-sm"></span>继续</button>
        <button id="WaitCloseBtn" type="button" class="btn btn-danger" style="width: 200px; height: 60px;" onclick="$('#WaitTips').fadeOut('slow');$('#SectionPlayer').fadeOut('slow');">取消</button>
      </div>
    </div>

    <!-- 演示标题 -->
    <div id="SectionPlayer" style="position: absolute; left: 10%; top: 10%; width: 80%; z-index: 999; display: none;">
      <div>
        <img src="img/Logo.png" alt="logo" />
      </div>
      <div style="margin-top: 2%;">
        <h2 id="SCaption" style="font-size: 80px; color: midnightblue; font-family: '阿里汉仪智能黑体', '素材集市酷方体', '庞门正道标题体', '微软雅黑'; background: linear-gradient(to top,rgba(0,0,255,0.5),rgba(255,255,255,0) 50%); padding: 0px 30px;">主标题</h2>
      </div>
      <div style="margin-top: 3%; text-align: center;">
        <h2 id="SSub" style="font-size: 60px; color: midnightblue; font-family: '素材集市酷方体', '阿里汉仪智能黑体', '庞门正道标题体', '微软雅黑'; display: grid; border: 1px solid midnightblue; padding: 0px 30px; margin: auto auto; background-color: rgb(255 255 0 / 0.30); width: 500px;">副标题</h2>
      </div>
    </div>

    <!-- 模型修改表单 -->
    <div id="ModifyBox" class="alert alert-primary row g-2 text-start" style="width: 400px; height: 100%; left: 0px; top: 0px; z-index: 1100; font-size: 14px; display: none;">
      <input type="hidden" name="MeshID" id="MeshID" value="" />
      <input type="hidden" name="MeshName" id="MeshName" value="" />
      <div class="col-md-12" title="模型配置">
        <button type="button" class="btn-close" id="ModifyCloseBox" style="float: right;"></button>
        <strong>模型配置</strong><br />
        <label>为选中模型添加基础信息</label>
      </div>

      <div class="form-floating col-md-12">
        <div id="PartCrumbs" class="input-group form-control">
        </div>
        <label>模型</label>
      </div>
      <div class="form-floating col-md-8">
        <input id="MeshTitle" name="MeshTitle" placeholder="" class="form-control" /><label for="MeshTitle">命名</label>
      </div>
      <div class="form-floating col-md-4">
        <button id="ModifyPartBtn" type="button" class="w-100 btn btn-lg btn-primary">调整姿态</button>
      </div>

      <div class="form-floating col-md-8">
        <input id="MeshDesc" name="MeshDesc" placeholder="" class="form-control" /><label for="MeshDesc">模型描述</label>
      </div>
      <div class="form-floating col-md-4">
        <input id="GroupName" name="GroupName" placeholder="" class="form-control" /><label for="GroupName">分组</label>
      </div>
      <div class="form-check form-switch form-floating col-md-4" style="background-color: rgb(255, 255, 255); border: 1px solid rgb(204, 204, 204); border-radius: 4px;">
        <input id="MeshTag" name="MeshTag" type="checkbox" placeholder="" class="form-check-input" style="width: 3em; margin-left: -1.5em; margin-top: 2em;" /><label for="MeshTag" style="padding-top: 5px;">显示标识</label>
      </div>

      <!-- 基本信息对话框 -->
      <div id="MeshBaseInfo" class="row g-2 text-start" style="margin: 0px 0px 0px -4px; height: 30px; display: none;">
        <div class="form-floating col-md-3" style="margin-top: 12px !important;"></div>
        <div class="form-floating col-md-4" style="margin-top: 12px !important;">
          <button id="SaveMeshBaseBtn" type="button" class="w-100 btn btn-lg btn-primary">保存</button>
        </div>
      </div>

      <!-- 详细事件对话框 -->
      <div id="MeshOtherInfo" class="row g-2 text-start" style="margin: 0px 0px 0px -4px; display: contents;">
        <div class="form-floating col-md-4">
          <select id="MaterialExample" name="MaterialExample" class="form-select">
            <option value="0">0 无</option>
            <option value="1">1 金属</option>
            <option value="2">2 漆面</option>
            <option value="3">3 塑料</option>
            <option value="4">4 水泥</option>
            <option value="5">5 石头</option>
            <option value="6">6 草地</option>
            <option value="7">7 玻璃</option>
            <option value="8">8 发光</option>
          </select><label for="MaterialExample">范例</label>
        </div>
        <div class="form-floating col-md-4">
          <select id="MaterialType" name="MaterialType" class="form-select">
            <option value="0">0 无</option>
            <option value="1">1 基础</option>
            <option value="2">2 深度</option>
            <option value="3">3 间隔</option>
            <option value="4">4 表面</option>
            <option value="5">5 光照</option>
            <option value="6">6 法线</option>
            <option value="7">7 镜面</option>
            <option value="8">8 物理</option>
            <option value="9">9 标准</option>
            <option value="10">10 卡通</option>
            <option value="11">11 原色</option>
            <option value="12">12 着色</option>
            <option value="13">13 阴影</option>
            <option value="14">14 精灵</option>
            <option value="15">15 直线</option>
            <option value="16">16 虚线</option>
          </select><label for="MaterialType">材质</label>
        </div>
        <div class="form-floating col-md-4">
          <div class="input-group colorpicker-demo form-control">
            <input id="MeshColor" name="MeshColor" type="text" value="#888888" style="width: 54px; font-size: 11px; border: 1px solid #cccccc; height: 20px; text-align: center;" />
            <span class="input-group-addon"><i style="width: 24px; height: 20px;"></i></span>
          </div>
          <label for="MeshColor">颜色</label>
        </div>

        <div class="form-floating input-group-sm col-md-4">
          <input id="MeshOpacity" name="MeshOpacity" placeholder="" type="range" min="0" max="1" step="0.01" value="1" class="form-control form-range" style="background-color: white;" /><label id="MeshOpacityLab" for="MeshOpacity">透明</label>
        </div>
        <div class="form-floating input-group-sm col-md-4">
          <input id="MeshShininess" name="MeshShininess" placeholder="" type="range" min="0" max="200" step="5" class="form-control form-range" style="background-color: white;" /><label id="MeshShininessLab" for="MeshShininess">光照</label>
        </div>

        <div class="form-floating input-group-sm col-md-12" style="border-radius: 0.2rem; background-color: white; border: 1px solid #b6d4fe; margin-left: 4px; width: 98%; padding: 10px;">
          <label style="padding-top: 5px;">贴图</label>
          <label style="padding-top: 5px; margin-left: 160px;">重复</label><br />
          <input type="hidden" name="TextureTxt" id="TextureTxt" value="" />
          <input id="SelectMap1Btn" type="button" class="btn btn-block btn-outline btn-primary" style="text-align: left;" value="纹理" />
          <input id="SelectMap2Btn" type="button" class="btn btn-block btn-outline btn-primary" style="text-align: left;" value="凹凸" />
          <input id="SelectMap3Btn" type="button" class="btn btn-block btn-outline btn-primary" style="text-align: left;" value="法向" />
          <input id="RepeatSBox" name="RepeatSBox" list="RepeatSList" placeholder="横向" style="width: 65px; text-align: center; margin-left: 10px;" />
          <datalist id="RepeatSList">
            <option value="0.001" />
            <option value="0.01" />
            <option value="0.1" />
            <option value="1" />
            <option value="10" />
            <option value="100" />
            <option value="1000" />
          </datalist>
          <input id="RepeatTBox" name="RepeatTBox" list="RepeatTList" placeholder="纵向" style="width: 65px; text-align: center;" />
          <datalist id="RepeatTList">
            <option value="0.001" />
            <option value="0.01" />
            <option value="0.1" />
            <option value="1" />
            <option value="10" />
            <option value="100" />
            <option value="1000" />
          </datalist>
        </div>
        <div class="form-floating col-md-4">
          <select id="FaceType" name="FaceType" class="form-select">
            <option value="0">正面</option>
            <option value="1">双面</option>
            <option value="2">背面</option>
          </select><label for="FaceType">面类型</label>
        </div>
        <div class="form-floating col-md-4">
          <select id="LoopType" name="LoopType" class="form-select">
            <option value="0">面贴图</option>
            <option value="1">循环贴图</option>
          </select><label for="LoopType">循环类型</label>
        </div>

        <div class="form-floating col-md-4">
          <select id="RotateType" name="RotateType" class="form-select">
            <option value="0">不旋转</option>
            <option value="1">90度</option>
            <option value="2">180度</option>
            <option value="3">270度</option>
          </select><label for="RotateType">贴图旋转</label>
        </div>
        <div class="tabs-container">
          <ul id="myTab" class="nav nav-tabs">
            <li id="tabLab-1" class="active"><a data-toggle="tab" href="#tab-1" aria-expanded="true">无</a></li>
            <li id="tabLab-2"><a data-toggle="tab" href="#tab-2" aria-expanded="false">提示</a></li>
            <li id="tabLab-3"><a data-toggle="tab" href="#tab-3" aria-expanded="false">链接</a></li>
            <li id="tabLab-4"><a data-toggle="tab" href="#tab-4" aria-expanded="false">变色</a></li>
            <li id="tabLab-5"><a data-toggle="tab" href="#tab-5" aria-expanded="false">变材质</a></li>
            <li id="tabLab-6"><a data-toggle="tab" href="#tab-6" aria-expanded="false">开关</a></li>
            <li id="tabLab-7"><a data-toggle="tab" href="#tab-7" aria-expanded="false">变量</a></li>
            <li id="tabLab-8"><a data-toggle="tab" href="#tab-8" aria-expanded="false">图片</a></li>
            <li id="tabLab-9"><a data-toggle="tab" href="#tab-9" aria-expanded="false">动画</a></li>
            <li id="tabLab-10"><a data-toggle="tab" href="#tab-10" aria-expanded="false">镜头</a></li>
            <li id="tabLab-11"><a data-toggle="tab" href="#tab-11" aria-expanded="false">指令</a></li>
          </ul>
          <div class="tab-content modifyTab">
            <div id="tab-1" class="tab-pane active">
              <div class="panel-body">
                <div class="col-md-12 row" title="无">
                  <strong>无</strong><br />
                  <label id="panel0">当用户点击当前模型时，场景不会有任何动作。</label>
                </div>
              </div>
            </div>
            <div id="tab-2" class="tab-pane">
              <div class="panel-body">
                <div class="col-md-12 row" title="提示">
                  <strong>提示</strong><br />
                  <label id="panel1">点击模型时，弹出信息提示。</label><div class="form-floating col-md-12">
                    <textarea id="InfoTxt" name="InfoTxt" placeholder="" rows="5" class="form-control" style="height: 80px;"></textarea><label for="InfoTxt">输入提示内容</label>
                  </div>
                </div>
              </div>
            </div>
            <div id="tab-3" class="tab-pane">
              <div class="panel-body">
                <div class="col-md-12 row" title="链接">
                  <strong>链接</strong><br />
                  <label id="panel2">点击时，以嵌入式形式打开链接。</label><div class="form-floating col-md-12">
                    <input id="LinkTxt" name="LinkTxt" placeholder="http://" class="form-control" /><label for="LinkTxt">输入链接页面地址</label>
                  </div>
                </div>
              </div>
            </div>
            <div id="tab-4" class="tab-pane">
              <div class="panel-body">
                <div class="col-md-12 row" title="变色">
                  <strong>变色</strong><br />
                  <label id="panel3">点击时，在多个颜色之间变化。</label>
                  <div class="form-floating input-group-sm col-md-6">
                    <input id="ColorBox1" name="ColorBox1" placeholder="" type="color" class="form-control" /><label for="ColorBox1">颜色</label>
                  </div>
                  <div class="form-floating col-md-6" style="margin-top: 12px !important;">
                    <button id="ColorAddBtn" type="button" class="btn btn-lg btn-outline-danger">添加</button>
                  </div>
                </div>
              </div>
            </div>
            <div id="tab-5" class="tab-pane">
              <div class="panel-body">
                <div class="col-md-12 row" title="变材质">
                  <strong>变材质</strong><br />
                  <label id="panel4">点击时，在原材质与新材质间切换。</label><div class="form-floating col-md-6">
                    <select id="MaterialList" name="MaterialList" class="form-select">
                      <option value="0">0 无</option>
                      <option value="1">1 基础</option>
                      <option value="2">2 深度</option>
                      <option value="3">3 间隔</option>
                      <option value="4">4 表面</option>
                      <option value="5">5 光照</option>
                      <option value="6">6 法线</option>
                      <option value="7">7 镜面</option>
                      <option value="8">8 物理</option>
                      <option value="9">9 标准</option>
                      <option value="10">10 卡通</option>
                      <option value="11">11 原色</option>
                      <option value="12">12 着色</option>
                      <option value="13">13 阴影</option>
                      <option value="14">14 精灵</option>
                      <option value="15">15 直线</option>
                      <option value="16">16 虚线</option>
                    </select><label for="MaterialList">材质</label>
                  </div>
                  <div class="form-floating input-group-sm col-md-6">
                    <input id="MaterialColor" name="MaterialColor" placeholder="" type="color" class="form-control" /><label for="MaterialColor">颜色</label>
                  </div>
                </div>
              </div>
            </div>
            <div id="tab-6" class="tab-pane">
              <div class="panel-body">
                <div class="col-md-12 row" title="开关">
                  <strong>开关</strong><br />
                  <label id="panel5">点击模型时，该模型在显示等布尔型属性上，进行真假值切换。</label>
                  <div class="radio radio-inline" style="float: left;">
                    <input id="VisibleRadio" type="radio" value="s" name="radioBox" /><label for="VisibleRadio">可视</label>
                  </div>
                  <div class="radio radio-inline" style="float: left;">
                    <input id="OtherRadio" type="radio" value="s" name="radioBox" /><label for="OtherRadio">其它</label>
                  </div>
                </div>
              </div>
            </div>
            <div id="tab-7" class="tab-pane">
              <div class="panel-body">
                <div class="col-md-12 row" title="变量">
                  <strong>变量</strong><br />
                  <label id="panel6">点击模型时，该模型在各类数值型属性上，进行数值切换。【暂无功能】</label>
                </div>
              </div>
            </div>
            <div id="tab-8" class="tab-pane">
              <div class="panel-body">
                <div class="col-md-12 row" title="图片">
                  <strong>图片</strong><br />
                  <label id="panel7">点击模型时，该模型的上方（鼠标点击位置附近），显示名称的精灵标识。</label>
                </div>
              </div>
            </div>
            <div id="tab-9" class="tab-pane">
              <div class="panel-body">
                <div class="col-md-12 row" title="动画">
                  <strong>动画</strong><br />
                  <label id="panel8">点击模型时，进行指定时长和距离的移动、缩放、旋转动画。</label><div class="form-floating col-md-3">
                    <select id="EventType" name="EventType" class="form-select" value="">
                      <option value="0">0 无</option>
                      <option value="1">1 单向移动</option>
                      <option value="2">2 往复移动</option>
                      <option value="3">3 单向旋转</option>
                      <option value="4">4 往复旋转</option>
                      <option value="5">5 单向缩放</option>
                      <option value="6">6 往复缩放</option>
                    </select><label for="EventType">类型</label>
                  </div>
                  <div class="form-floating col-md-3">
                    <select id="EventDirection" name="EventDirection" class="form-select">
                      <option value="0">0 全部</option>
                      <option value="1">1 X</option>
                      <option value="2">2 Y</option>
                      <option value="3">3 Z</option>
                    </select><label for="EventDirection">方向</label>
                  </div>
                  <div class="form-floating col-md-3">
                    <input id="EventValue1" name="EventValue1" placeholder="" class="form-control" value="0" /><label for="EventValue1">起始数值</label>
                  </div>
                  <div class="form-floating col-md-3">
                    <input id="EventValue2" name="EventValue2" placeholder="" class="form-control" value="0" /><label for="EventValue2">终止数值</label>
                  </div>
                </div>
              </div>
            </div>
            <div id="tab-10" class="tab-pane">
              <div class="panel-body">
                <div class="col-md-12 row" title="镜头">
                  <strong>镜头</strong><br />
                  <label id="panel9">点击模型时，以鼠标点击位置为追踪点，转向特定镜头位置。</label><div class="form-floating col-md-4">
                    <input id="Px" name="Px" placeholder="" class="form-control" /><label for="Px">鼠标X坐标</label>
                  </div>
                  <div class="form-floating col-md-4">
                    <input id="Py" name="Py" placeholder="" class="form-control" /><label for="Py">鼠标Y坐标</label>
                  </div>
                  <div class="form-floating col-md-4">
                    <input id="Pz" name="Pz" placeholder="" class="form-control" /><label for="Pz">鼠标Z坐标</label>
                  </div>
                  <div class="form-floating col-md-4">
                    <input id="Cx" name="Cx" placeholder="" class="form-control" /><label for="Cx">镜头X坐标</label>
                  </div>
                  <div class="form-floating col-md-4">
                    <input id="Cy" name="Cy" placeholder="" class="form-control" /><label for="Cy">镜头Y坐标</label>
                  </div>
                  <div class="form-floating col-md-4">
                    <input id="Cz" name="Cz" placeholder="" class="form-control" /><label for="Cz">镜头Z坐标</label>
                  </div>
                </div>
              </div>
            </div>
            <div id="tab-11" class="tab-pane">
              <div class="panel-body">
                <div class="col-md-12 row" title="指令">
                  <strong>指令</strong><br />
                  <label id="panel10">点击时，调用业务集成平台对硬件的关联指令，以驱动物理世界。</label><div class="form-floating col-md-10">
                    <select id="CmdList" name="CmdList" class="form-select">
                      <option value="0">0 集成指令：电源开关1</option>
                      <option value="1">1 集成指令：电源开关2</option>
                    </select><label for="CmdList">集成平台指令</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="form-floating col-md-4" style="margin-top: 12px !important;">
          <button id="HideMesh" type="button" class="w-100 btn btn-lg btn-outline-danger">隐藏</button>
        </div>
        <div class="form-floating col-md-4" style="margin-top: 12px !important;">
          <button id="DelMeshConfig" type="button" class="w-100 btn btn-lg btn-outline-danger">移除</button>
        </div>
        <div class="form-floating col-md-4" style="margin-top: 12px !important;">
          <button id="SaveMeshConfig" type="button" class="w-100 btn btn-lg btn-primary">保存</button>
        </div>
      </div>
    </div>

    <!-- 关联数据图表 -->
    <div class="modal inmodal" id="InsertVisual" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content animated bounceInRight">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">
              <span aria-hidden="true">&times;</span><span class="sr-only">关闭</span>
            </button>
            <h4 class="modal-title">插入已有图表</h4>
            <small class="font-bold">在树目录中选择已经设计好的图表，添加到当前页面</small>
          </div>
          <div class="modal-body">
            <div id="jstree1">
              <ul>
                <li class="jstree-open">
                  <a href='#'>所有数据服务</a>
                  <ul>
                    <li class="jstree-open">
                      <a href='#'>人力资源</a>
                      <ul>
                        <li data-jstree='{"type":"chart"}'><a onclick='ChartInsert(22, "部门资源", "人力资源", "面积图");' href='#'>部门资源</a></li>
                      </ul>
                    </li>
                  </ul>
                </li>
              </ul>
            </div>
          </div>
          <div class="modal-footer">
            <input name="SystemID" type="hidden" id="SystemID" value="0" />
            <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>

            <button type="button" class="btn btn-primary" data-dismiss="modal" id="ChartSaveBtn" onclick="ChartSave();">添加</button>
          </div>
        </div>
      </div>
    </div>

    <script type="text/javascript">
      //鼠标选中并正在通过模型配置对话框编辑的对象
      //临时保存，用来实时刷新材质和颜色
      var MouseSelectMesh = null;
    </script>

    <script type="module">

      //#region 基础函数，包括模块导入
      import * as THREE from './js/three.module.js';                    //引擎

      import Stats from './jsm/libs/stats.module.js';                   //状态监视
      import { GUI } from './jsm/libs/lil-gui.module.min.js';           //图形界面

      import { OBJLoader } from './jsm/loaders/OBJLoader.js';           //OBJ模型加载
      import { FBXLoader } from './jsm/loaders/FBXLoader.js';           //FBX模型加载
      import { STLLoader } from './jsm/loaders/STLLoader.js';           //STL模型加载
      import { GLTFLoader } from './jsm/loaders/GLTFLoader.js';         //GLTF模型加载

      import { OrbitControls } from './jsm/controls/OrbitControls.js';  //轨道控制器
      import { OutlineEffect } from './jsm/effects/OutlineEffect.js';   //边线效果器
      import { Curves } from './jsm/curves/CurveExtras.js';             //曲线模块
      import { IfcTextStyle } from './jsm/loaders/ifc/web-ifc-api.js';  //Ifc

      import { BoxLineGeometry } from './jsm/geometries/BoxLineGeometry.js';      //盒线几何体
      import { WEBVR } from './jsm/vr/WebVR.js';                                  //WebVR虚拟功能
      import { VRButton } from './jsm/webxr/VRButton.js';                         //界面按钮
      import { XRControllerModelFactory } from './jsm/webxr/XRControllerModelFactory.js'; //控制器

      import { FontLoader } from './jsm/loaders/FontLoader.js';                   //字体加载
      import { TextGeometry } from './jsm/geometries/TextGeometry.js';            //文字几何体

      import { DragControls } from './jsm/controls/DragControls.js';              //模型拖放

      import { TransformControls } from './jsm/controls/TransformControls.js';

      //后台程序从数据库中获取场景的配置信息

      let SceneID = 2053;
      let BDSID = 0;

      let SceneTitle = '纪兰党性教育基地精简版';
      let SceneType = '0';
      let SceneModel = '/Files/8e99812e-aa55-4bf1-8d3e-41fb61b15c46.mp4';
      let SceneConfig = 'BackColor : #000000, PolarAngle : false, ShowFPS : false, ShowLight : undefined, ShowRole : false, FrameLine : false, BulidTree : false, Grid : false, Rotate : 0, Damping : 0, Sky : 2, Unit : 0, AmbientLight : 0.9, PointLight : 0.8';
      let CameraConfig = 'rx : -0.34249977891079497, ry : -0.3393504056795708, rz : -0.1181344554433547, px : -36.23620524605374, py : 37.36367557233452, pz :110.91627897128454, tx : 1.7868917411705698, ty : 1.189291945085694, tz : 9.460141253532779';
      let ModelSize = '688896';
      let State = '0';
      let ScreenStr = '降本增效,资源管理,生产成本,测试保存'.split(',');

      var ScreenID = 0;

      var MapDict = {
        "面_楼前_左": "/UserMap/1f8610f0-a4cf-4476-9c50-0a8b34dc6e7f.jpg,0.0001,0.0001",
        "面_楼前_左边": "/UserMap/962703e7-3962-45b1-a828-abd60e407719.jpg,0.0001,0.0001",
        "面_楼前_右边": "/UserMap/962703e7-3962-45b1-a828-abd60e407719.jpg,0.0001,0.0001",
        "面_楼前_左中": "/UserMap/f731b55e-9ea7-49e5-8475-b13a9c72047e.jpg,0.0001,0.0001",
        "面_楼前_中": "/UserMap/b4cd8cfc-c51c-45eb-9817-4cc5d6491b37.jpg,0.0001,0.0001",
        "面_楼前_右中": "/UserMap/362e0592-7a1f-43d7-81c3-b472fdac40dc.jpg,0.0001,0.0001",
        "面_楼前_右": "/UserMap/1f8610f0-a4cf-4476-9c50-0a8b34dc6e7f.jpg,0.0001,0.0001",
        "西沟展览馆门_左": "/UserMap/26ce512b-f57a-424a-9dd7-9f3a691f098f.jpg,0.0014,0.001",
        "西沟展览馆门_右": "/UserMap/26ce512b-f57a-424a-9dd7-9f3a691f098f.jpg,0.0014,0.001",
        "面_题词": "/UserMap/954fd0b4-ab38-4d0d-b7ab-b3883417883e.jpg,0.0001,0.0001",
        "面_前言": "/UserMap/64217f4e-bb79-4ae5-af24-7f5b2ac8cfa0.jpg,0.0001,0.0001",
        "面_太行英雄": "/UserMap/1e5ddb6c-3a4f-4ffd-9621-7560d30e0f0e.jpg,0.0001,0.0001",
        "面_苏联参观学习访问": "/UserMap/222db4d7-7e07-4edc-80f8-f07f368860d6.jpg,0.0001,0.0001",
        "面_边区最早的互助组织": "/UserMap/1893c96f-7c37-43e4-a982-b9282becfd8a.jpg,0.0001,0.0001",
        "面_西沟序曲": "/UserMap/44496482-c5ba-4f8b-9c23-ea55eb4e26c5.jpg,0.0001,0.0001",
        "面_荣获共和国勋章": "/UserMap/5e55149f-25b2-4f60-85ca-a4e31d6e3d94.jpg,0.0001,0.0001",
        "面_当代表就要代表人民": "/UserMap/9ed4e323-6a0e-4780-ac0c-db082da809d1.jpg,0.0001,0.0001",
        "面_人民代表大会的见证人": "/UserMap/497b3d26-6a4e-43cf-8bfe-7d552661ab0c.jpg,0.0001,0.0001",
        "西沟展览馆门_左001": "/UserMap/26ce512b-f57a-424a-9dd7-9f3a691f098f.jpg,0.0015,0.001",
        "西沟展览馆门_左002": "/UserMap/26ce512b-f57a-424a-9dd7-9f3a691f098f.jpg,0.0015,0.001",
        "西沟展览馆门_左005": "/UserMap/26ce512b-f57a-424a-9dd7-9f3a691f098f.jpg,0.0015,0.001",
        "西沟展览馆门_左003": "/UserMap/26ce512b-f57a-424a-9dd7-9f3a691f098f.jpg,0.0015,0.001",
        "西沟展览馆门_左004": "/UserMap/26ce512b-f57a-424a-9dd7-9f3a691f098f.jpg,0.0015,0.001"
      };

      //VR调试专用球
      //var obj1

      //场景父对象
      var parent;

      var BoxArray = [];
      var BoxCount = 28;
      var boxIndex = 0;
      var pl = 0, pr = 0, pt = 0, pw = 300, ph = 200;
      var bWidth = 620, bHeight = 480, bLeft = 10, bTop = 10, bScale = 1;
      var FrameType = '';

      let SceneDate = moment();
      var scaleValue = 0.001;
      var DesignMode = false;
      var DesignPart = null;

      var IsDesign = false;

      const clock = new THREE.Clock();
      let mixer;

      //当前登录的用户信息
      let TheUserID = 1;
      let TheUserName = "user";

      //场景的默认配置
      var SceneBackColor = "0x708090";
      var ScenePolarAngle = false;
      var SceneShowFPS = false;
      var SceneShowLight = false;
      var SceneShowRole = false;
      var SceneFrameLine = false;
      var SceneBulidTree = false;
      var SceneGrid = false;
      var SceneRotate = 0;
      var SceneDamping = 0;
      var SceneSky = 0;
      var SceneUnit = 0;
      var AmbientLight = 0.5;
      var PointLight = 0.8;

      //根据数据库中保存的配置，还原场景配置
      if (SceneConfig.length > 0) {
        //console.log(SceneConfig);
        var config = SceneConfig.split(",");
        for (var i = 0; i < config.length; i++) {
          var cf = config[i].replace("'", "");
          var cfArr = cf.split(":");
          var cfValue = cfArr[1].trim();
          //console.log(cfValue);

          switch (cfArr[0].trim()) {
            case "BackColor": SceneBackColor = cfValue; break;
            case "PolarAngle": ScenePolarAngle = cfValue == "true"; break;
            case "ShowFPS": SceneShowFPS = cfValue == "true"; break;
            case "ShowLight": SceneShowLight = cfValue == "true"; break;
            case "ShowRole": SceneShowRole = cfValue == "true"; break;
            case "FrameLine": SceneFrameLine = cfValue == "true"; break;
            case "BulidTree": SceneBulidTree = cfValue == "true"; break;
            case "Grid": SceneGrid = cfValue == "true"; break;
            case "Rotate": SceneRotate = parseFloat(cfValue); break;
            case "Damping": SceneDamping = parseFloat(cfValue); break;
            case "Sky": SceneSky = parseFloat(cfValue); break;
            case "Unit": SceneUnit = parseInt(cfValue); break;
            case "AmbientLight": AmbientLight = parseFloat(cfValue); break;
            case "PointLight": PointLight = parseFloat(cfValue); break;
          }
        }
      }

      //Unit : " + $("#SceneUnitBox").val() + ", AmbientLight : " + $("#AmbientLightTxt").val() + ", PointLight : " + $("#PointLightTxt").val();

      //创建加载画动工具
      let at = new AnimationTools();

      //创建AJAX对象
      let jh = new JQueryHelper();

      //弹窗管理器
      let pf = new PopupForm();

      //工具栏
      let tb = new Toolbar();

      //鼠标选中的物体，用来恢复模型
      var oldObj = null, oldMaterial;

      //  容器对象、 控制器、  镜头、  镜头目标、 追踪镜头、    镜头管理器、  视管
      let container, controls, camera, cameraEye, splineCamera, cameraHelper, tubeGeometry;

      //  场景、 渲染器、  定时、	    转换器、状态、 效果、  蓝光光圈、       模型日期
      let scene, renderer, startTime, object, stats, effect, BlueLightObject, MeshDate;

      //控制手柄
      let controller1, controller2;
      let controllerGrip1, controllerGrip2;

      let room;

      let count = 0;
      const radius = 0.08;
      //let normal = new THREE.Vector3();

      const relativeVelocity = new THREE.Vector3();
      //const clock = new THREE.Clock();

      let group, textMesh1, textMesh2, textGeo, materials;


      let firstLetter = true;

      //在场景中增加一个浮动的标识文本
      let text = 'Ambition3D',
        bevelEnabled = true,
        font = "12px Microsoft YaHei",
        fontName = 'optimer', // helvetiker, optimer, gentilis, droid sans, droid serif
        fontWeight = 'bold'; // normal bold

      const height = 0.1,
        size = 0.1,
        hover = 3,
        curveSegments = 0.04,
        bevelThickness = 0.02,
        bevelSize = 0.015;

      const mirror = true;

      const fontMap = {
        'helvetiker': 0,
        'optimer': 1,
        'gentilis': 2,
        'droid/droid_sans': 3,
        'droid/droid_serif': 4
      };

      const weightMap = {
        'regular': 0,
        'bold': 0.1
      };

      const reverseFontMap = [];
      const reverseWeightMap = [];

      for (const i in fontMap) reverseFontMap[fontMap[i]] = i;
      for (const i in weightMap) reverseWeightMap[weightMap[i]] = i;

      let targetRotation = 0;
      let targetRotationOnPointerDown = 0;

      let pointerX = 0;
      let pointerXOnPointerDown = 0;

      let windowHalfX = window.innerWidth / 2;

      let fontIndex = 1;


      //所有网格对象
      var meshs = [], sprites = [], Steps = [];
      var cube = 1;

      //环境光：浅灰色
      var ambientLight = new THREE.AmbientLight(0xcccccc, AmbientLight);
      //点光：亮白
      var pointLight = new THREE.PointLight(0xffffff, PointLight); //0.8

      //正在插入的模型参数
      var InsertPart;
      var edgeMaterial = new THREE.LineBasicMaterial({ color: 0x999999, linewidth: 3, });

      //网格对象配置
      var meshsConfig = [];
      var lineLength = 0;
      var rangeEnable = false;

      var leftWidth = 0, rightWidth = 0, bottomHeight = 0;

      //基础区域:      大地、    道路、  草地、       水池
      var BaseArea = ["Ground", "Path", "GreenArea", "Wave"];

      //视管
      const pipeSpline = new THREE.CatmullRomCurve3([
        new THREE.Vector3(-1000, 1500, -1500),
        new THREE.Vector3(0, 1200, -1000),
        new THREE.Vector3(1000, 800, 0),
        new THREE.Vector3(0, 60, 400),
        new THREE.Vector3(0, 40, 250)
      ]);

      //追踪点
      const direction = new THREE.Vector3();
      const binormal = new THREE.Vector3();
      const normal = new THREE.Vector3();
      const position = new THREE.Vector3();
      const lookAt = new THREE.Vector3();
      //#endregion

      //#region 场景管理器

      //场景管理器
      SceneManage();

      //场景循环刷新
      animate();

      //场景管理器
      function SceneManage() {

        //容器对象
        container = document.createElement('div');
        container.style.cssText = "position: absolute; top: 0px; left: 0px; z-index: -1;";
        document.body.appendChild(container);

        //创建透镜镜头
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.001, 500000);
        //camera.position.x = 0;
        //camera.position.y = 10;
        //camera.position.z = 15;

        //场景
        scene = new THREE.Scene();

        //天空盒
        if (SceneSky > 0) {
          var path = "img/cube" + SceneSky + "/";
          var urls = [
            path + 'px.jpg', path + 'nx.jpg',
            path + 'py.jpg', path + 'ny.jpg',
            path + 'pz.jpg', path + 'nz.jpg'
          ];

          var textureCube = new THREE.CubeTextureLoader().load(urls);
          scene.background = textureCube;
        }
        else {
          //背景色
          scene.background = new THREE.Color(Number(SceneBackColor.replace("#", "0x")));
        }

        //雾化距离
        //scene.fog = new THREE.Fog(0xa0a0a0, 1000, 2000);

        //环境光：浅灰色
        scene.add(ambientLight);

        //点光：亮白
        camera.add(pointLight);

        //设置框
        if (SceneShowLight) {
          const gui = new GUI({ title: "设置", width: 200 });

          const params = {
            环境光: AmbientLight,
            点光: PointLight
          };

          gui.add(params, '环境光', 0.01, 5).onChange(function (value) {
            ambientLight.intensity = value;
          });
          gui.add(params, '点光', 0.01, 5).onChange(function (value) {
            pointLight.intensity = value;
          });
        }

        //圆球
        //obj1 = new THREE.Mesh(new THREE.IcosahedronGeometry(0.1, 3), new THREE.MeshLambertMaterial({ color: 0xffff00 }));
        //obj1.position.x = 0;
        //obj1.position.y = 0.5;
        //obj1.position.z = 0;
        //scene.add(obj1);

        //地平网格
        if (SceneGrid) {
          var gridHelper = new THREE.GridHelper(20, 20);
          scene.add(gridHelper);
        }

        //线型：灰色框线

        //父级对象
        parent = new THREE.Object3D();
        scene.add(parent);

        //光圈
        //const textureLoader = new THREE.TextureLoader();
        //var map = textureLoader.load('img/BlueLight.png');
        //map.repeat.x = 2;
        //var geo = new THREE.CylinderGeometry(10, 10, 30, 50, 1, true);
        //geo.translate(0, 1, 0);
        //var material = new THREE.MeshStandardMaterial({
        //  transparent: true,
        //  map,
        //  opacity: 1,
        //});
        //BlueLightObject = BulidCylinder(geo, material);
        //BlueLightObject.visible = false;
        //scene.add(BlueLightObject)

        //创建视管
        //tubeGeometry = new THREE.TubeGeometry(pipeSpline, 100, 2, 10, false);
        //const mate = new THREE.MeshLambertMaterial({ color: 0xff00ff });
        //const mesh = new THREE.Mesh(tubeGeometry, mate);
        //const wm = new THREE.MeshBasicMaterial({ color: 0x000000, opacity: 0.3, wireframe: true, transparent: true });
        //const wireframe = new THREE.Mesh(tubeGeometry, wm);
        //mesh.add(wireframe);
        //mesh.visible = false;
        //parent.add(mesh);

        //正常镜头
        parent.add(camera);

        //追踪镜头
        splineCamera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 10000);
        splineCamera.position.y = 0;
        splineCamera.position.z = 0;
        parent.add(splineCamera);

        cameraHelper = new THREE.CameraHelper(splineCamera);
        scene.add(cameraHelper);

        //scene.add(camera);

        cameraEye = new THREE.Mesh(new THREE.SphereGeometry(10), new THREE.MeshBasicMaterial({ color: 0xffff00 }));
        cameraEye.visible = false;
        parent.add(cameraEye);

        splineCamera.visible = false;
        cameraHelper.visible = false;

        //状态
        if (SceneShowFPS) {
          stats = new Stats();
          document.body.appendChild(stats.dom);
        }

        //模型管理器
        const manager = new THREE.LoadingManager(loadModel);

        //模型加载时，进行建筑着色处理
        function loadModel() {

          //console.log(object);
          object.traverse(function (child) {

            //循环贴图
            var AreaDict = {
              //'GreenArea': "img/GreenArea.jpg" //绿化带
            };

            //着色
            var ColorDict = {
              'Dricab': 0xc0c0c0, //驾驶室
              'Bumper': 0x666666, //保险杠
              'DriDoor1': 0xffffff, //主驾门
              'DriDoor2': 0xffffff, //副驾门
              'InstrumentDesk': 0x333333, //仪表台
              'SteeringWheel': 0x000000, //方向盘
              'Left': 0x009933, //左侧壳体
              'Right': 0x009933, //右侧壳体
              'Converter': 0x999999, //逆变器
              'GREEN': 0x009933, //绿
              'RED': 0xff0000, //红
              'YELLOW': 0xffff00, //黄
              'BLUE': 0x0000ff,  //蓝
              'GreenArea': 0x6ab421, //绿化带
              'Equipment003': 0x66ccff //广告牌
            };

            //边框线
            if (SceneFrameLine) {
              if (child.isMesh) {
                if (BaseArea.indexOf(child.name) < 0) {
                  var edges = new THREE.EdgesGeometry(child.geometry, 45);
                  var l = new THREE.LineSegments(edges, edgeMaterial);
                  child.add(l);
                }
              }
            }

            //为组增加框线
            if (child.isGroup) {
              //child.material = edgeMaterial;
              //var edges = new THREE.EdgesGeometry(child.geometry, 45);
              //var l = new THREE.LineSegments(edges, edgeMaterial);
              //child.add(l);
            }
            //console.log(child);

            var objName = child.name;
            if (objName.length > 0) {
              //面贴图
              var mapInfo = MapDict[objName];
              if (mapInfo != undefined) {
                console.log(mapInfo);
                var mapArr = mapInfo.split(',');
                var mapFile = mapArr[0];
                var repeatS = parseFloat(mapArr[1]);
                var repeatT = parseFloat(mapArr[2]);

                var mapObj1 = new THREE.TextureLoader().load(mapFile);
                var mate1 = new THREE.MeshLambertMaterial({ map: mapObj1, side: THREE.DoubleSide, transparent: false, opactity: 1, color: 0xCCCCCC, shininess: 10 });
                mate1.map.repeat.set(repeatS, repeatT);
                mate1.map.wrapS = mate1.map.wrapT = THREE.RepeatWrapping;
                mate1.map.encoding = THREE.sRGBEncoding;
                mate1.transparent = true;
                child.material = mate1;
              }
              else {
                //循环贴图
                var areaFile;
                areaFile = AreaDict[objName];
                if (areaFile != undefined) {
                  var mapObj2 = new THREE.TextureLoader().load(areaFile);
                  var mate2 = new THREE.MeshPhongMaterial({ color: 0xffffff, map: mapObj2, side: THREE.DoubleSide });
                  //var gg = new THREE.PlaneGeometry(500, 500);
                  mate2.map.repeat.set(4, 4);
                  //mate2.transparent = true;
                  mate2.map.wrapS = mate2.map.wrapT = THREE.RepeatWrapping;
                  mate2.map.encoding = THREE.sRGBEncoding;
                  //child.rotation.x = - Math.PI / 2;
                  //child.geometry = gg;
                  child.material = mate2;
                  child.receiveShadow = true;
                }
                else {
                  //着色
                  var colorValue;
                  colorValue = ColorDict[child.name];
                  if (colorValue == undefined) colorValue = 0x999999;
                  if (objName.substring(1, 3) == "Dor") {
                    child.material = new THREE.MeshPhongMaterial({ color: mesh.Color, shininess: 50, opacity: 0.9, transparent: true, side: THREE.DoubleSide });
                    //child.material.color = new THREE.Color(0x009933);
                    //console.log(child.name);
                  }
                  else if (objName.substring(0, 5) == "Glass") {
                    child.material = new THREE.MeshPhongMaterial({ color: 0x0000ff, shininess: 80, opacity: 0.2, transparent: true });
                  }
                  else if (objName.substring(0, 5) == "Wheel") {
                    if (objName.length > 6) {
                      child.material = new THREE.MeshPhongMaterial({ color: 0xeeeedd, shininess: 200, opacity: 1 });
                    }
                    else {
                      child.material = new THREE.MeshPhongMaterial({ color: 0x555555, shininess: 50, opacity: 1 });
                    }
                  }
                  else if (objName.substring(0, 7) == "Battery") {
                    child.material = new THREE.MeshPhongMaterial({ color: 0xc3f45c, emissive: 0x2abc30, specular: 0x0, shininess: 100, opacity: 1 });
                    //child.material = new THREE.MeshBasicMaterial({ color: 0x10ff0a, opacity: 1 });
                  }
                  else {
                    if (child.material != null) {
                      child.material.color = new THREE.Color(colorValue);
                      child.material.side = THREE.DoubleSide;
                      //child.material.emissive = child.material.color;
                      //child.material.emissiveIntensity = 1;
                      //child.material.emissiveMap = child.material.map;
                    } else {
                      child.material = new THREE.MeshPhongMaterial({ color: colorValue, shininess: 50, opacity: 0.75, transparent: true });
                    }
                  }
                }
              }
            }

            //植树模型，如果模型是种植模型，要隐藏起来
            if (!tb.setMesh(objName, child)) {
              child.index = 0;
            }

            meshs.push(child);
          });

          //对模型进行统一缩放，绘图以毫米为单位，VR显示以1000毫米（米）为单位
          switch (SceneUnit) {
            case 0: scaleValue = 0.001; break;
            case 1: scaleValue = 0.01; break;
            case 2: scaleValue = 0.1; break;
            case 3: scaleValue = 1; break;
            case 4: scaleValue = 10; break;
            case 5: scaleValue = 100; break;
            case 6: scaleValue = 1000; break;
            case 7: scaleValue = 10000; break;
          }
          //console.log(scaleValue);
          object.scale.set(scaleValue, scaleValue, scaleValue);
          scene.add(object);
        }

        //模型加载进度
        manager.onProgress = function (item, loaded, total) {
          //console.log(item + " 加载完毕!");
          //console.log(loaded);
          //console.log(total);

          if (loaded == total) {
            at.Stage(2, logoCallBack);
            var jData = {
              "SceneID": SceneID
            };
            jh.LoadEntityList("LoadMeshConfigForScene.html", MeshConfigLoadOver, jData);
          }
        };

        //模型加载判断
        if (SceneModel.length > 4) {
          switch (SceneModel.substr(SceneModel.length - 3, 3).toLowerCase()) {
            case "obj":
              const loader1 = new OBJLoader(manager);
              loader1.load(SceneModel, function (obj) {
                object = obj;
              }, onProgress, onError);
              break;
            case "fbx":
              const loader2 = new FBXLoader(manager);
              loader2.load(SceneModel, function (obj) {
                object = obj;
                //播放动画
                mixer = new THREE.AnimationMixer(obj);
                const action = mixer.clipAction(obj.animations[0]);
                action.play();

              }, onProgress, onError);
              break;
            case "stl":
              const loader3 = new STLLoader(manager);
              loader3.load(SceneModel, function (obj) {
                object = obj;
              }, onProgress, onError);
              break;
            case "ltf": //gltf
              const loader4 = new GLTFLoader(manager);
              loader4.load(SceneModel, function (obj) {
                object = obj;
              }, onProgress, onError);
              break;

            default:
              const loader5 = new FBXLoader(manager);
              loader5.load(SceneModel, function (obj) {
                object = obj;
              }, onProgress, onError);
              break;
              break;
          }
        }


        //模型下载速度
        function onProgress(xhr) {
          //if (xhr.lengthComputable) {
          //    const percentComplete = xhr.loaded / xhr.total * 100;
          //    console.log('model ' + Math.round(percentComplete, 2) + '% downloaded');
          //}
        }

        //空的错误处理
        function onError() { }

        //提示器组
        group = new THREE.Group();
        group.position.x = -1.5;
        group.position.y = 1.5;
        group.position.z = 0;
        scene.add(group);
        loadFont();

        //渲染器(启用全屏抗锯齿)
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setPixelRatio(window.devicePixelRatio * 1.5); //2倍像素，费显卡
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        renderer.xr.setFramebufferScaleFactor(1);
        container.appendChild(renderer.domElement);

        //启用XR虚拟交互并添加XR按钮
        document.body.appendChild(WEBVR.createButton(renderer));

        //手柄选择
        function onSelectStart() {
          this.userData.isSelecting = true;
        }

        function onSelectEnd() {
          this.userData.isSelecting = false;
        }

        controller1 = renderer.xr.getController(0);
        controller1.addEventListener('selectstart', onSelectStart);
        controller1.addEventListener('selectend', onSelectEnd);
        controller1.addEventListener('connected', function (event) {
          this.add(buildController(event.data));
        });
        controller1.addEventListener('disconnected', function () {
          this.remove(this.children[0]);
        });
        scene.add(controller1);

        controller2 = renderer.xr.getController(1);
        controller2.addEventListener('selectstart', onSelectStart);
        controller2.addEventListener('selectend', onSelectEnd);
        controller2.addEventListener('connected', function (event) {
          this.add(buildController(event.data));
        });
        controller2.addEventListener('disconnected', function () {
          this.remove(this.children[0]);
        });
        scene.add(controller2);

        // The XRControllerModelFactory will automatically fetch controller models
        // that match what the user is holding as closely as possible. The models
        // should be attached to the object returned from getControllerGrip in
        // order to match the orientation of the held device.

        const controllerModelFactory = new XRControllerModelFactory();

        controllerGrip1 = renderer.xr.getControllerGrip(0);
        controllerGrip1.add(controllerModelFactory.createControllerModel(controllerGrip1));
        scene.add(controllerGrip1);

        controllerGrip2 = renderer.xr.getControllerGrip(1);
        controllerGrip2.add(controllerModelFactory.createControllerModel(controllerGrip2));
        scene.add(controllerGrip2);

        materials = [
          new THREE.MeshPhongMaterial({ color: 0x000099, flatShading: true }), // front
          new THREE.MeshPhongMaterial({ color: 0xffff00 }) // side
        ];

        //效果器
        effect = new OutlineEffect(renderer);
        effect.enabled = false;

        //控制器
        controls = new OrbitControls(camera, renderer.domElement);

        controls.enableDamping = SceneDamping != 0; //镜头阻尼惯性
        controls.dampingFactor = SceneDamping; //阻尼惯性值
        //controls.target.set(0, 1, 0);

        //控制器自动旋转
        controls.autoRotate = SceneRotate != 0;
        controls.autoRotateSpeed = SceneRotate;

        //最大仰角（极坐标角度）
        if (ScenePolarAngle) {
          controls.maxPolarAngle = Math.PI / 2;
        }

        var rx = 0, ry = 1, rz = 0;
        var px = 3, py = 1, pz = 1;
        var tx = 0, ty = 0, tz = 0;

        //还原场影的镜头位置
        if (CameraConfig.length > 0) {
          var config = CameraConfig.split(",");
          for (var i = 0; i < config.length; i++) {
            var cf = config[i].replace("'", "");
            var cfArr = cf.split(":");
            var cfValue = parseFloat(cfArr[1]);

            switch (cfArr[0].trim()) {
              case "rx": rx = cfValue; break;
              case "ry": ry = cfValue; break;
              case "rz": rz = cfValue; break;
              case "px": px = cfValue; break;
              case "py": py = cfValue; break;
              case "pz": pz = cfValue; break;
              case "tx": tx = cfValue; break;
              case "ty": ty = cfValue; break;
              case "tz": tz = cfValue; break;
            }
            camera.position.set(px, py, pz);
            //camera.rotation.set(rx, ry, rz);

            //camera.updateProjectionMatrix();
            controls.target.set(tx, ty, tz);
          }

          //console.log(camera.position);
          //console.log(camera.rotation);
          //console.log(controls.target);
        }
        else {

          camera.position.set(px, py, pz);
          camera.rotation.set(rx, ry, rz);

          //camera.updateProjectionMatrix();
          controls.target.set(tx, ty, tz);

          //camera.quaternion.x = qx;
          //camera.quaternion.y = qy;
          //camera.quaternion.z = qz;
        }

        //controls.target.set(0, 850, 0);
        controls.update();

        //窗体尺寸调整事件
        window.addEventListener('resize', WindowReSize);

        //页面鼠标点击事件
        document.addEventListener('dblclick', DocumentMouseDown, false);

      }

      //加载字体配置
      function loadFont() {
        const loader = new FontLoader();
        loader.load('' + fontName + '_' + fontWeight + '.typeface.html', function (response) {
          font = response;
          refreshText();
        });
      }

      //创建文字标识
      function createText() {
        //console.log(font);
        textGeo = new TextGeometry(text, {
          font: font,
          size: size,
          height: height,
          curveSegments: curveSegments,
          bevelThickness: bevelThickness,
          bevelSize: bevelSize,
          bevelEnabled: bevelEnabled
        });

        textGeo.computeBoundingBox();

        const centerOffset = - 0.5 * (textGeo.boundingBox.max.x - textGeo.boundingBox.min.x);

        textMesh1 = new THREE.Mesh(textGeo, materials);

        textMesh1.position.x = 0;
        textMesh1.position.y = 0;
        textMesh1.position.z = 0;

        textMesh1.rotation.x = 0;
        textMesh1.rotation.y = Math.PI / 2;

        group.add(textMesh1);

        //if (mirror) {

        //  textMesh2 = new THREE.Mesh(textGeo, materials);

        //  textMesh2.position.x = centerOffset;
        //  textMesh2.position.y = - hover - 100;
        //  textMesh2.position.z = 100 + height;

        //  textMesh2.rotation.x = Math.PI;
        //  textMesh2.rotation.y = 0; //Math.PI * 2;

        //  group.add(textMesh2);

        //}

      }

      //刷新文字模型，以便在XR中进行调试
      function refreshText() {
        //updatePermalink();
        group.remove(textMesh1);
        //if (mirror) group.remove(textMesh2);
        if (!text) return;
        //天空中的Ambition3D的立体文字
        //createText();
      }

      //控制器回调，激发手柄事件
      function handleController(controller) {

        if (controller.userData.isSelecting) {

          //camera.position.set(controller.position.x, controller.position.y, controller.position.z);




          //圆球，现阶段隐藏起来
          //obj1.position.x = controller.position.x; // + controller.quaternion.x;
          //obj1.position.y = controller.position.y; // + controller.quaternion.y;
          //obj1.position.z = controller.position.z; // + controller.quaternion.z;

          //parent.position.x = -obj1.position.x * 20;
          //parent.position.y = obj1.position.y * 1;
          //parent.position.z = -obj1.position.z * 20;





          //const object = room.children[count++];

          //object.position.copy(controller.position);
          //object.userData.velocity.x = (Math.random() - 0.5) * 3;
          //object.userData.velocity.y = (Math.random() - 0.5) * 3;
          //object.userData.velocity.z = (Math.random() - 9);
          //object.userData.velocity.applyQuaternion(controller.quaternion);

          //if (count === room.children.length) count = 0;

          //var vector = new THREE.Vector3(((event.clientX - leftWidth) / (window.innerWidth - leftWidth - rightWidth)) * 2 - 1, -(event.clientY / (window.innerHeight - bottomHeight)) * 2 + 1, 0.5);
          //vector = vector.unproject(camera);
          //var raycaster = new THREE.Raycaster(camera.position, vector.sub(camera.position).normalize());
          ////console.log(meshs);
          //var intersects = raycaster.intersectObjects(meshs, true);
          ////console.log(intersects);
          //if (intersects.length > 0) {
          //  //console.log(intersects[0]);
          //  var selectObj = null;
          //  var intersectsObj = null;

          //  for (var i = 0; i < intersects.length; i++) {
          //    if (intersects[i].object.visible) {
          //      selectObj = intersects[i].object;
          //      intersectsObj = intersects[i];
          //      break;
          //    }
          //  }

          //  selectObj.material = new THREE.MeshLambertMaterial({ color: Math.random() * 0xffffff });
          //}

        }

      }

      //激活渲染器
      function animate() {

        //requestAnimationFrame(SceneRefresh);

        renderer.setAnimationLoop(TimeCycle);
        //TimeCycle();

        //controls.update(); //启用阻尼需要更新

        //$("#x1").text(camera.rotation.x.toFixed(2));
        //$("#y1").text(camera.rotation.y.toFixed(2));
        //$("#z1").text(camera.rotation.z.toFixed(2));
        //$("#x2").text(camera.position.x.toFixed(2));
        //$("#y2").text(camera.position.y.toFixed(2));
        //$("#z2").text(camera.position.z.toFixed(2));
        //$("#x3").text(camera.quaternion.x.toFixed(2));
        //$("#y3").text(camera.quaternion.y.toFixed(2));
        //$("#z3").text(camera.quaternion.z.toFixed(2));
        //$("#x4").text(controls.target.x.toFixed(2));
        //$("#y4").text(controls.target.y.toFixed(2));
        //$("#z4").text(controls.target.z.toFixed(2));

        //$("#fov").text(camera.fov.toFixed(2));
        //$("#aspect").text(camera.aspect.toFixed(2));
        //$("#near").text(camera.near.toFixed(2));
        //$("#far").text(camera.far.toFixed(2));
        //console.log(camera);

        //$("#Cx").val(camera.position.x);
        //$("#Cy").val(camera.position.y);
        //$("#Cz").val(camera.position.z);
      }

      //定时循环，处理镜头运动和光圈放大
      function TimeCycle() {

        handleController(controller1);
        handleController(controller2);


        $("#Cx").val(camera.position.x);
        $("#Cy").val(camera.position.y);
        $("#Cz").val(camera.position.z);


        if (SceneShowFPS) { stats.begin(); }

        controls.update();

        //const time = Date.now();
        //const looptime = 10000;
        //const t = (time % looptime) / looptime;
        ////$("#v1").text(t.toFixed(4));

        //tubeGeometry.parameters.path.getPointAt(t, position);
        ////position.multiplyScalar(1);

        //const segments = tubeGeometry.tangents.length;
        //const pickt = t * segments;
        //const pick = Math.floor(pickt);
        //const pickNext = (pick + 1) % segments;

        //binormal.subVectors(tubeGeometry.binormals[pickNext], tubeGeometry.binormals[pick]);
        //binormal.multiplyScalar(pickt - pick).add(tubeGeometry.binormals[pick]);

        //tubeGeometry.parameters.path.getTangentAt(t, direction);
        //const offset = 1;

        //normal.copy(binormal).cross(direction);

        //// we move on a offset on its binormal

        //position.add(normal.clone().multiplyScalar(1));

        //splineCamera.position.copy(position);
        //cameraEye.position.copy(position);

        //// using arclength for stablization in look ahead

        //tubeGeometry.parameters.path.getPointAt((t + 30 / tubeGeometry.parameters.path.getLength()) % 1, lookAt);
        ////lookAt.multiplyScalar(1);

        //// camera orientation 2 - up orientation via normal

        //if (true) lookAt.copy(position).add(direction);
        //splineCamera.lookAt(new THREE.Vector3(0, 50, -600));
        //splineCamera.quaternion.setFromRotationMatrix(splineCamera.matrix);

        //BlueLightObject.scale.x += 1
        //BlueLightObject.scale.z += 1
        //if (BlueLightObject.scale.x > 50) {
        //  BlueLightObject.scale.x = 1
        //  BlueLightObject.scale.z = 1
        //}

        cameraHelper.update();
        TWEEN.update();
        //effect.render(scene, cube == 1 ? camera : splineCamera);

        const delta = clock.getDelta();
        if (mixer) mixer.update(delta);

        renderer.render(scene, camera);

        //text = camera.position.x.toFixed(2) + ' ' + camera.position.y.toFixed(2) + ' ' + camera.position.z.toFixed(2);
        //refreshText();

        if (SceneShowFPS) { stats.end(); }

      }

      //手柄连接事件
      function buildController(data) {
        let geometry, material;
        switch (data.targetRayMode) {
          case 'tracked-pointer':
            //手柄事件，产生手柄射线
            geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.Float32BufferAttribute([0, 0, 1, 0, 0, - 20], 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute([0.5, 0.5, 0.5, 0, 0, 0], 3));
            material = new THREE.LineBasicMaterial({ vertexColors: true, blending: THREE.AdditiveBlending, linewidth: 5 });
            return new THREE.Line(geometry, material);
          case 'gaze':
            geometry = new THREE.RingGeometry(0.002, 0.04, 32).translate(0, 0, - 1);
            material = new THREE.MeshBasicMaterial({ opacity: 0.5, transparent: true });
            return new THREE.Mesh(geometry, material);
        }

      }

      //根据后台数据，创造模型
      function MeshConfigLoadOver(res) {
        meshsConfig = res.MeshConfig;
        if (meshsConfig != null) {
          for (var i = 0; i < meshsConfig.length; i++) {
            for (var j = 0; j < meshs.length; j++) {
              if (meshs[j].isMesh) {
                var mc = meshsConfig[i];

                var mapInfo = MapDict[meshs[j].name];
                if (mapInfo != undefined) {
                  console.log(mapInfo);
                  var mapArr = mapInfo.split(',');
                  var mapFile = mapArr[0];
                  var repeatS = parseFloat(mapArr[1]);
                  var repeatT = parseFloat(mapArr[2]);

                  var mapObj = new THREE.TextureLoader().load(mapFile);
                  var mate = new THREE.MeshLambertMaterial({ map: mapObj, side: THREE.DoubleSide, transparent: false, opactity: 1, color: 0xCCCCCC, shininess: 10 });
                  mate.map.repeat.set(repeatS, repeatT);
                  mate.map.wrapS = mate.map.wrapT = THREE.RepeatWrapping;
                  mate.map.encoding = THREE.sRGBEncoding;
                  mate.transparent = true;
                  meshs[j].material = mate;
                }
                else if (meshs[j].name == decodeURI(mc.MeshName)) {
                  meshs[j].tag = mc.MeshID;
                  meshs[j].title = decodeURI(mc.MeshTitle);
                  meshs[j].group = decodeURI(mc.GroupName);
                  //console.log(meshs[j]);
                  //if (meshsConfig[i].MaterialType > 0) {
                  var m = BulidMaterial(mc, meshs[j].material);
                  if (m != null) {
                    meshs[j].material = m;
                    //console.log(meshs[j]);
                  }
                  //}
                  if (mc.ShowTag) {
                    var p = new THREE.Vector3(parseFloat(mc.X), parseFloat(mc.Y), parseFloat(mc.Z));
                    var tag = BulidMeshTxtSprite(decodeURI(mc.MeshTitle), "yellow", p);
                    sprites.push(tag);
                    scene.add(tag);
                  }
                }
              }
            }
          }
        }

        //加载到第三步，数据加载完成
        at.Stage(3, logoCallBack);

        var jData = {
          "SceneID": SceneID
        };
        jh.LoadEntityList("LoadStepsForScene.html", BulidUserInterface, jData);
      }

      //#endregion

      //#region 公共方法

      //为模型配置表单，绑定选项卡点击事件
      $("#myTab").find("a").click(function () {
        ModifyMenuClick(this);
      });

      //模型配置选项卡，切换
      function ModifyMenuClick(obj) {
        $("#myTab .active").removeClass("active");
        $(obj).parent().addClass("active");

        $(".modifyTab").find(".active").hide();
        $(".modifyTab").find(".active").removeClass("active");

        $($(obj).attr("href")).addClass("active");
        $($(obj).attr("href")).show();
      }

      //按照模型对象的配置参数，创建材质
      function BulidMaterial(meshConfig, material) {

        console.log(meshConfig);

        var color = 0xcccccc, opacity = 1, shininess = 1;
        //从模型配置中获取参数
        if (meshConfig.MaterialData.length > 0) {
          var json = eval('(' + meshConfig.MaterialData.replace("#", "0x") + ')');
          meshConfig.MeshColor = json.color;
          meshConfig.Shininess = json.shininess;
          meshConfig.Opacity = json.opacity;

          if (meshConfig.Opacity < 1) {
            opacity = meshConfig.Opacity;
          }

          color = meshConfig.MeshColor;
          shininess = meshConfig.Shininess;
        }
        else {
          try {
            color = material.color;
            opacity = material.opacity;
            shininess = material.shininess;
          } catch { }
        }

        material = ConfigMaterial(material, color, opacity, shininess, meshConfig.FaceType, meshConfig.MaterialType, meshConfig.MaterialExample)
        return material;
      }

      function ConfigMaterial(material, color, opacity, shininess, faceType, materialType, materialExample) {
        var m;

        //材质参数
        var parameters = { transparent: false, opactity: 1, color: 0xCCCCCC, shininess: 10 };

        if (opacity < 1) {
          parameters.transparent = true;
          parameters.opacity = opacity;
        }

        parameters.color = color;
        parameters.shininess = shininess;

        //面类型
        switch (parseInt(faceType)) {
          case 0: //正面
            parameters.side = THREE.FrontSide;
            break;
          case 1: //双面
            parameters.side = THREE.DoubleSide;
            break;
          case 2: //背面
            parameters.side = THREE.BackSide;
            break;
        }

        //材质类型
        switch (parseInt(materialType)) {
          case 0: //通用
            m = new THREE.MeshStandardMaterial(parameters);
            break;
          case 1: //基础材质
            m = new THREE.MeshBasicMaterial(parameters);
            break;
          case 2: //深度
            m = new THREE.MeshDepthMaterial(parameters);
            break;
          case 3: //间隔
            m = new THREE.MeshDistanceMaterial(parameters);
            break;
          case 4: //表面
            m = new THREE.MeshLambertMaterial(parameters);
            break;
          case 5: //光照
            m = new THREE.MeshMatcapMaterial(parameters);
            break;
          case 6: //法线
            m = new THREE.MeshNormalMaterial(parameters);
            break;
          case 7: //镜面
            m = new THREE.MeshPhongMaterial(parameters);
            break;
          case 8: //物理
            m = new THREE.MeshPhysicalMaterial(parameters);
            break;
          case 9: //标准
            m = new THREE.MeshStandardMaterial(parameters);
            break;
          case 10: //卡通
            m = new THREE.MeshToonMaterial(parameters);
            break;
          case 11: //原色
            m = new THREE.PointsMaterial(parameters);
            break;
          case 12: //着色
            m = new THREE.ShaderMaterial(parameters);
            break;
          case 13: //阴影
            m = new THREE.ShadowMaterial(parameters);
            break;
          case 14: //精灵
            m = new THREE.SpriteMaterial(parameters);
            break;
          case 15: //直线
            m = new THREE.LineBasicMaterial(parameters);
            break;
          case 16: //虚线
            m = new THREE.LineDashedMaterial(parameters);
            break;
          default:
            m = material;
            break;
        }

        //范例
        switch (parseInt(materialExample)) {
          case 1: //金属
            m = new THREE.MeshStandardMaterial(parameters);
            m.metalness = 1.0;
            m.roughness = 0.6;
            break;
          case 2: //漆面
            m = new THREE.MeshLambertMaterial(parameters);
            m.metalness = 0.8;
            m.roughness = 0.8;
            m.clearcoat = 0.5;
            m.clearcoatRoughness = 0.03;
            m.sheen = 0.5;
            break;
          case 3: //塑料
            m = new THREE.MeshLambertMaterial(parameters);
            break;
          case 4: //水泥
            var mapObj1 = new THREE.TextureLoader().load('img/Concrete.png');
            mapObj1.wrapS = THREE.RepeatWrapping;
            mapObj1.wrapT = THREE.RepeatWrapping;
            mapObj1.repeat.set(0.01, 0.01);
            m = new THREE.MeshLambertMaterial(parameters);
            m.map = mapObj1;
            m.map.needsUpdate = true;
            //m.side = THREE.DoubleSide;
            break;
          case 5: //石头
            var mapObj2 = new THREE.TextureLoader().load('img/Rock.png');
            mapObj2.wrapS = THREE.RepeatWrapping;
            mapObj2.wrapT = THREE.RepeatWrapping;
            mapObj2.repeat.set(0.01, 0.01);
            m = new THREE.MeshLambertMaterial(parameters);
            m.map = mapObj2;
            m.map.needsUpdate = true;
            //m.side = THREE.DoubleSide;
            break;
          case 6: //草地
            var mapObj3 = new THREE.TextureLoader().load('img/Lawn.png');
            mapObj3.wrapS = THREE.RepeatWrapping;
            mapObj3.wrapT = THREE.RepeatWrapping;
            mapObj3.repeat.set(0.01, 0.01);
            m = new THREE.MeshLambertMaterial(parameters);
            m.map = mapObj3;
            m.map.needsUpdate = true;
            //m.side = THREE.DoubleSide;
            break;
          case 7: //玻璃
            m = new THREE.MeshPhongMaterial(parameters);
            m.metalness = 1.0;
            m.roughness = 0.6;
            break;
          case 8: //发光
            m = new THREE.MeshStandardMaterial(parameters);
            m.metalness = 1.0;
            m.roughness = 0.6;
            m.emissive = m.color;
            m.emissiveIntensity = 1;
            break;
        }
        return m;
      }

      function getColor(number) {
        const red = number >> 16 & 0xff;
        const green = number >> 8 & 0xff;
        const blue = number & 0xff;
        return '#' + ((1 << 24) + (red << 16) + (green << 8) + blue).toString(16).slice(1);
      }

      //显示模型的命名标识
      function BulidMeshTxtSprite(text, style, p) {
        var canvas = document.createElement("canvas");
        canvas.width = 200;
        canvas.height = 60;

        var context = canvas.getContext("2d", { antialias: false, depth: false });
        context.beginPath();
        context.font = "30px Microsoft YaHei";
        context.fillStyle = style;
        context.fillText(text, 40, 50);
        context.fill();
        context.stroke();

        var txtSprite = new THREE.SpriteMaterial({
          map: new THREE.CanvasTexture(canvas),
          blendint: THREE.AdditiveBlending
        });

        var s = new THREE.Sprite(txtSprite);
        s.scale.set(0.3, 0.1, 1)
        s.position.set(p.x, p.y + 1, p.z);
        return s;
      }

      //创建一个大光圈
      function BulidCylinder(geometry, material) {
        var obj = new THREE.Object3D();
        var mesh = new THREE.Mesh(geometry, material);
        mesh.material.side = THREE.BackSide; // 前面FrontSide  背面：BackSide 双面：DoubleSide
        mesh.renderOrder = 0;
        obj.add(mesh);

        var mesh = new THREE.Mesh(geometry, material.clone());
        mesh.material.side = THREE.FrontSide; // front faces
        mesh.renderOrder = 1;
        obj.add(mesh);
        obj.position.x = 0;
        obj.position.y = 0;
        obj.position.z = 0;
        obj.scale.y = 1;
        //console.log(obj);
        return obj
      }
      //#endregion

      //#region 模式切换和动画

      //建模：使用模式和设计模式切换
      //注：多个工具栏需要调用模式切换
      //    切换会影响整个界面的布局
      function ModeSwitch() {
        DesignMode = !DesignMode;
        $("#editMapBtn").text(DesignMode ? "停止建模" : "建模");

        if (DesignMode) {
          $("#NavigationBox").show();
          $("#EditBox").show();
          $("#StageBox").show();
          $("#PartsBox").show();
          //chartDom.style.display = "";
          //myChart.resize();

          $("#toolbar").css("right", "410px");
          $("#SceneInfo").css("left", "310px");
        }
        else {
          $("#NavigationBox").hide();
          $("#EditBox").hide();
          $("#StageBox").hide();
          $("#PartsBox").hide();
          $("#PartBulidBox").hide();
          //chartDom.style.display = "none";
          //myChart.resize();

          $("#toolbar").css("right", "10px");
          $("#SceneInfo").css("left", "10px");
        }


        leftWidth = DesignMode ? 300 : 0;
        rightWidth = DesignMode ? 400 : 0;
        container.style.cssText = "position: absolute; z - index: -1; top: 0px; left: " + leftWidth + "px;";

        bottomHeight = DesignMode ? 0 : 0;

        WindowReSize();
      }

      //建模：生成用户界面
      function BulidUserInterface(StepsList) {

        Steps = StepsList.Steps;

        if (Steps == undefined) {
          Steps = [];
        }

        //顶部中间鼠标操作提示
        //tb.Prompt();

        //顶部中间提示框
        tb.Alert(function () {
          $("#alertBox").hide();
          TreeObj = null;
        });

        //iFrame弹窗
        tb.ProductIFrame(
          "FrameBox",

          //提示信息关闭
          function () {
            $("#FrameDiv").attr("src", "about:blank");
            $("#FrameBox").hide();
          }
        );

        //左上角的模型和当前日期提示框
        tb.ProductTitle(
          "SceneTitleLab",
          "SceneDateLab",
          SceneTitle,
          "",
          SceneShowFPS
        );

        //构造界面：左侧模型导航
        tb.ProductMeshNav(meshs,
          ModeSwitch,

          //模型显隐
          function (obj) {
            var m;
            var meshName = this.getAttribute("mesh");
            for (var i = 0; i < meshs.length; i++) {
              if (meshs[i].name == meshName) {
                m = meshs[i];
                break;
              }
            }
            m.visible = !m.visible;
            if (m.visible) {
              this.setAttribute("class", "fa fa-eye")
              obj.target.parentNode.setAttribute("class", "");
            }
            else {
              this.setAttribute("class", "fa fa-eye-slash")
              obj.target.parentNode.setAttribute("class", "s");
            }
            //console.log(m);
          },

          //镜头转到模型
          function (obj) {
            //console.log(obj);

            //console.log(obj.srcElement.mesh);
            var m;
            var meshName = this.getAttribute("mesh");
            for (var i = 0; i < meshs.length; i++) {
              if (meshs[i].name == meshName) {
                m = meshs[i];
                break;
              }
            }
            var mc;
            if (m.tag > 0) {
              for (var c in meshsConfig) {
                if (meshsConfig[c].MeshName == m.name) {
                  mc = meshsConfig[c];
                  break;
                }
              }
            }
            //console.log($("#AnimationBox").is(":visible"));
            if ($("#AnimationBox").is(":visible")) {
              var p = m.name;
              var con = $("#AnimationTitle").val();
              if (con.length > 0) {
                con += ',';
              }
              $("#AnimationTitle").val(con + p);


              switch ($("#AnimationStyle").val()) {
                case '0'://移动
                  //console.log(0);
                  switch ($("#AnimationArouse").val()) {
                    case '0': //x
                      $("#BeginValue").val(m.position.x);
                      break;
                    case '1': //y
                      $("#BeginValue").val(m.position.y);
                      break;
                    case '2': //z
                      $("#BeginValue").val(m.position.z);
                      break;
                  }


                  break;
                case '1'://缩放
                  //console.log(1);
                  switch ($("#AnimationArouse").val()) {
                    case '0': //x
                      $("#BeginValue").val(m.scale.x);
                      break;
                    case '1': //y
                      $("#BeginValue").val(m.scale.y);
                      break;
                    case '2': //z
                      $("#BeginValue").val(m.scale.z);
                      break;
                  }

                  break;
                case '2'://旋转
                  //console.log(2);
                  switch ($("#AnimationArouse").val()) {
                    case '0': //x
                      $("#BeginValue").val(m.rotation.x);
                      break;
                    case '1': //y
                      $("#BeginValue").val(m.rotation.y);
                      break;
                    case '2': //z
                      $("#BeginValue").val(m.rotation.z);
                      break;
                  }

                  break;

              }
            }
            else {

              MoveCameraForMesh(m, mc);
            }
          },

          //模型编辑
          function MeshEdit() {
            var m;
            var meshName = this.getAttribute("mesh");
            for (var i = 0; i < meshs.length; i++) {
              if (meshs[i].name == meshName) {
                m = meshs[i];
                break;
              }
            }
            var mc;
            if (m != null) {
              if (meshsConfig != null) {
                for (var i = 0; i < meshsConfig.length; i++) {
                  if (meshsConfig[i].MeshName == m.name) {
                    mc = meshsConfig[i];
                    break;
                  }
                }
              }
            }
            //console.log(meshName);
            //console.log(m.name);
            //console.log(mc);

            $("#MeshBaseInfo").css("display", "contents");
            $("#MeshOtherInfo").css("display", "none");

            var MeshID = 0;
            if (m.tag > 0) {
              MeshID = m.tag;
            }

            //ModifyShow(MeshID, m.name, mc);

            $("#MeshID").attr("value", MeshID);
            $("#MeshLab").text("#" + MeshID);
            $("#MeshTag").attr("checked", false);
            $("#MeshName").val(m.name);
            $("#MeshTitle").val("");
            $("#MeshDesc").val("");
            $("#GroupName").val("");

            if (mc != null) {
              $("#MeshTag").attr("checked", mc.ShowTag);
              $("#MeshTitle").val(decodeURI(mc.MeshTitle));
              $("#MeshDesc").val(decodeURI(mc.MeshDesc));
              $("#GroupName").val(decodeURI(mc.GroupName));
            }

            $("#ModifyBox").show();
          },

          //整组模型显隐
          function GroupToggle(obj) {
            //var m;
            var ms = [];
            var groupName = this.getAttribute("group");
            //console.log(groupName);
            for (var i = 0; i < meshs.length; i++) {
              if (meshs[i].isMesh) {
                if (groupName == "") {
                  //console.log(meshs[i].group);
                  if (meshs[i].group == null || meshs[i].group == undefined || meshs[i].group == groupName) {
                    ms.push(meshs[i]);
                  }
                }
                else {
                  if (meshs[i].group == groupName) {
                    ms.push(meshs[i]);
                  }
                }
              }
            }

            //console.log(ms);

            var groupVisible = this.getAttribute("class") == "fa fa-eye";
            if (!groupVisible) {
              this.setAttribute("class", "fa fa-eye")
              obj.target.parentNode.setAttribute("class", "");
              for (var i = 0; i < ms.length; i++) {
                ms[i].visible = true;
              }
            }
            else {
              this.setAttribute("class", "fa fa-eye-slash")
              obj.target.parentNode.setAttribute("class", "s");
              for (var i = 0; i < ms.length; i++) {
                ms[i].visible = false;
              }
            }
            //console.log(m);
          },

          //隐藏标识
          function () {
            TagEnable = !TagEnable;
            $("#tagBtn").text(!TagEnable ? "隐藏标识" : "显示标识");

            for (var i = 0; i < sprites.length; i++) {
              sprites[i].visible = !TagEnable;
            }
          },

          //隐藏命名对象
          function () {
            for (var i = 0; i < meshs.length; i++) {
              if (BulidIsHide) {
                meshs[i].visible = true;
              }
              else if (meshs[i].name.length > 0 && BaseArea.indexOf(meshs[i].name) < 0) {
                meshs[i].visible = false;
              }
            }
            for (var i = 0; i < sprites.length; i++) {
              sprites[i].visible = BulidIsHide;
            }

            $("#hideBtn").text(BulidIsHide ? "隐藏命名对象" : "显示命名对象");
            BulidIsHide = !BulidIsHide;
          },

          //全部隐藏
          function () { },

          //全部显示
          function () { }
        );

        //构造界面：顶部工具栏
        tb.EditToolbar(
          ModeSwitch,

          //产品设置
          ModelSetup,

          //测距
          function () {
            rangeEnable = !rangeEnable;

            px = 0, py = 0, pz = 0;
            pHas = false;
            sphereArr = [];
            lineLength = 0;
            $("#BoxRangeBtn").text(!rangeEnable ? "测距" : "停止");
          },

          //演示
          function () {
            StepPlayInit();
          },

          //布局
          function () {
            //$("#chartLeftBox").show();
            //$("#chartRightBox").show();
          },

          //可视化数据
          function () {
            $("#VisualBindBtn").attr("disabled", true);
            $("#VisualBindBox").show();
          },

          SceneShowRole,

          SceneBulidTree
        );

        //构造界面：右侧场景编辑
        var boxStage = tb.BoxStage(
          //关闭事件
          ModeSwitch,

          //删除
          StepDel,
          //设置
          StepSetup,
          //播放
          StepPlayInit,

          //暂停等待
          WaitSave,
          //新增模型显示
          StepAddStageToggle,
          //镜头轨迹
          CameraLocusSave,
          //字幕描述
          HeaderSave,
          //动画效果
          AnimationSave,
          //章节标题
          SectionSave,
          //节点确认
          TaskSave
        );

        boxStage.appendChild(tb.BulidStageTable(
          Steps,

          //场景编辑：暂停等待
          StepClick0,
          //场景编辑：修改暂停等待
          StepEdit0,

          //场景编辑：模型显示
          StepClick1,
          //场景编辑：修改模型显示
          StepEdit1,

          //场景编辑：镜头轨迹
          StepClick2,
          //场景编辑：修改镜头轨迹
          StepEdit2,

          //场景编辑：字幕描述
          StepClick3,
          //场景编辑：修改字幕描述
          StepEdit3,

          //场景编辑：动画效果
          StepClick4,
          //场景编辑：修改动画效果
          StepEdit4,

          //场景编辑：章节标题
          StepClick5,
          //场景编辑：修改章节标题
          StepEdit5,

          //场景删除
          StepDel
        ))

        at.Stage(4, logoCallBack);

        jh.LoadEntityList("LoadPartTree.html", BulidParts, "");


        if (BDSID > 0) {
          var jData = {
            "BDSID": BDSID
          };
          jh.LoadEntityList("/Service/IsoBDSs.asmx/LoadIsoBDSItem", BulidBDSLine, jData);
        }
      }

      //插入模型
      function BulidParts(PartTree) {
        tb.BulidParts(PartTree, ShowPartBulidBox)
      }

      //显示模型插入对话框
      function ShowPartBulidBox() {
        InsertPart = this.obj;

        DesignMode = true;
        DesignPart = null;

        $("#PartImage").attr("src", InsertPart.PicFile);
        $("#PartTitle").text(decodeURI(InsertPart.PartName));
        $("#PartBulidBox").show();

        //console.log(this.obj);
      }

      function BulidBDSLine(BDSList) {
        //console.log(BDSList.IsoBDSItems);

        //创建轨迹开始
        const material = new THREE.MeshBasicMaterial({ color: 0xffff00 });

        var ox = 0, oy = 0, oz = 0;

        BDSList.IsoBDSItems.forEach(
          function (e) {
            //console.log(e);
            var nx, ny, nz;

            //Y轴向上

            nx = e.E;
            ny = e.M;
            nz = e.N - 0.0095;
            const points = [];

            var ov = new THREE.Vector3(ox, oy, oz);
            var nv = new THREE.Vector3(nx, ny, nz)
            points.push(ov);
            points.push(nv);
            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            const line = new THREE.Line(geometry, material);
            //lineLength += nv.distanceTo(pv);
            scene.add(line);
            sphereArr.push(line);

            ox = nx;
            oy = ny;
            oz = nz;
            //scene.add(bulidTxtSprite(lineLength.toFixed(1) + "m", "yellow", intersects[0].point));
          }
        )

        //创建轨迹完
      }

      function ReloadStep() {
        var jData = {
          "SceneID": SceneID
        };
        jh.LoadEntityList("/Service/Steps.asmx/LoadStepsForScene", BulicStepTab, jData);
      }

      function BulicStepTab(StepsList) {

        Steps = StepsList.Steps;

        if (Steps == undefined) {
          Steps = [];
        }

        $("#StageTable").remove();

        $("#StageBox").append(tb.BulidStageTable(
          Steps,

          //场景编辑：暂停等待
          StepClick0,
          //场景编辑：修改暂停等待
          StepEdit0,

          //场景编辑：模型显示
          StepClick1,
          //场景编辑：修改模型显示
          StepEdit1,

          //场景编辑：镜头轨迹
          StepClick2,
          //场景编辑：修改镜头轨迹
          StepEdit2,

          //场景编辑：字幕描述
          StepClick3,
          //场景编辑：修改字幕描述
          StepEdit3,

          //场景编辑：动画效果
          StepClick4,
          //场景编辑：修改动画效果
          StepEdit4,

          //场景编辑：章节标题
          StepClick5,
          //场景编辑：修改章节标题
          StepEdit5,

          StepDel

        ));
      }



      var TagEnable = false;
      var BulidIsHide = false;

      //#endregion

      //#region 表单：鼠标事件

      //表示测距时，是否已经标出起点
      var pHas = false;
      //鼠标命中模型的点
      var px, py, pz;

      //测距产生的标识对象列表，在启停测距时清空
      var sphereArr = [];

      //页面鼠标点击事件
      function DocumentMouseDown(event) {
        //console.log(event.target);

        //判断鼠标点击的对象，是不是模型
        var threeClick = true;
        if (!(event.target instanceof HTMLCanvasElement)) { threeClick = false; }
        if (event.clientY > window.innerHeight - bottomHeight) { threeClick = false; }
        if (event.clientX < leftWidth || event.clientX > window.innerWidth - leftWidth - rightWidth) { threeClick = false; }

        //console.log(threeClick);

        //鼠标命中模型区域
        if (threeClick) {

          //console.log(leftWidth);
          //console.log(rightWidth);
          //console.log(bottomHeight);

          /* 鼠标在屏幕上点击的时候，得到二维坐标p(x, y),再加上深度坐标的范围(0, 1), 就可以形成两个三位坐标A(x1, y1, 0), B(x2, y, 1),
           * 由于它们的Z轴坐标是0和1，则转变到投影坐标系的话，一定分别是前剪切平面上的点和后剪切平面上的点，也就是说，在投影坐标系中，
           * A点一定在能看见的所有模型的最前面，B点一定在能看见的所有的模型的最后边，将AB点连成线，AB线穿过的物体就是被点击的物体。
           * 而 Three.js提供一个射线类Raycasting来拾取场景里面的物体，更方便的使用鼠标来操作3D场景。*/

          //使用射线从镜头位置，向鼠标方向发射，以命中目标

          var vector = new THREE.Vector3(((event.clientX - leftWidth) / (window.innerWidth - leftWidth - rightWidth)) * 2 - 1, -(event.clientY / (window.innerHeight - bottomHeight)) * 2 + 1, 0.5);
          vector = vector.unproject(camera);
          var raycaster = new THREE.Raycaster(camera.position, vector.sub(camera.position).normalize());
          //console.log(meshs);
          var intersects = raycaster.intersectObjects(meshs, true);
          //console.log(intersects);
          if (intersects.length > 0) {
            //console.log(intersects[0]);
            var selectObj = null;
            var intersectsObj = null;

            //找到第一个可视的模型，做为命中模型
            for (var i = 0; i < intersects.length; i++) {
              if (intersects[i].object.visible) {
                selectObj = intersects[i].object;
                intersectsObj = intersects[i];
                break;
              }
            }
            //console.log(intersects);

            px = intersectsObj.point.x;
            py = intersectsObj.point.y;
            pz = intersectsObj.point.z;



            //此处对选中物体进行了临时的材质转换，实现命中效果
            if (selectObj != null) {

              //if (oldObj != null) {
              //  oldObj.material = oldMaterial;
              //}
              ////防止命中物体的框线
              //if (selectObj.type == 'LineSegments') {
              //  oldObj = selectObj.parent;
              //}
              //else {
              //  oldObj = selectObj;
              //}
              //oldMaterial = selectObj.material;

              //建模模式
              if (DesignMode) {
                //如果模型对话框显示，则插入模型
                if ($("#PartBulidBox").is(':visible')) {

                  $("#PartBulidBox").hide();

                  var PartManager = new THREE.LoadingManager(PartLoad);
                  var PartLoader = new FBXLoader(PartManager);
                  PartLoader.load(InsertPart.FileName, function (obj) {
                    obj.name = decodeURI(InsertPart.PartName);
                    obj.IsPartGroup = true;
                    object = obj;
                  }, partProgress, partError);

                  //模型加载时，进行建筑着色处理
                  function PartLoad() {

                    object.traverse(function (child) {

                      child.IsPart = true;
                      if (child.isMesh) {
                        child.frustumCulled = false;
                        child.castShadow = true;
                        child.material.emissive = child.material.color;
                        child.material.emissiveMap = child.material.map;
                        child.material.vertexColors = false;
                      }

                      //边框线
                      if (child.isMesh) {
                        var edges = new THREE.EdgesGeometry(child.geometry, 45);
                        var l = new THREE.LineSegments(edges, edgeMaterial);
                        child.add(l);
                      }
                      meshs.push(child);
                    });


                    var transformControl = new TransformControls(camera, renderer.domElement);
                    scene.add(transformControl);//控件对象添加到场景对象
                    //transformControl.setMode('rotate');
                    //拖拽控件对象
                    var dragcontrols = new DragControls(object, camera, renderer.domElement);
                    //拖拽控件对象设置鼠标事件
                    dragcontrols.addEventListener('hoveron', function (event) {
                      //控件对象transformControl与选中的对象object绑定
                      transformControl.attach(event.object);
                    })


                    console.log(scaleValue);
                    object.scale.set(scaleValue, scaleValue, scaleValue);
                    object.position.x = px;
                    object.position.y = py;
                    object.position.z = pz;

                    DesignPart = object;

                    scene.add(object);
                  }

                  function partProgress(xhr) { }

                  function partError() { }

                }
                else {
                  //否则修改现场的模型
                  //获取对象在数据库中的编号
                  var MeshID = 0;
                  if (selectObj != null) {
                    if (selectObj.tag != null) {
                      if (selectObj.tag > 0) {
                        MeshID = selectObj.tag;
                      }
                    }
                  }

                  MouseSelectMesh = selectObj;

                  //不管在不在数字库，都弹出修改表单
                  ModifyShow(MeshID, selectObj.name, intersectsObj);
                }
              }
              else {
                //非建模状态，如果对象具有数据库中的编号，则激发事件
                if (selectObj.tag != null) {
                  if (selectObj.tag > 0) {
                    MeshEvent(oldObj.name);
                  }
                }
              }
            }

            //测距功能
            if (rangeEnable) {
              const material = new THREE.MeshBasicMaterial({ color: 0xffff00 });
              //pHas表示是否已经有起点
              if (pHas) {
                var nx, ny, nz;
                nx = intersects[0].point.x;
                ny = intersects[0].point.y;
                nz = intersects[0].point.z;
                const points = [];
                var pv = new THREE.Vector3(px, py, pz);
                var nv = new THREE.Vector3(nx, ny, nz)
                points.push(pv);
                points.push(nv);
                const geometry = new THREE.BufferGeometry().setFromPoints(points);
                const line = new THREE.Line(geometry, material);
                lineLength += nv.distanceTo(pv);
                scene.add(line);
                sphereArr.push(line);

                scene.add(bulidTxtSprite(lineLength.toFixed(1) + "m", "yellow", intersects[0].point));

                //创建了从起点或上一点的连线，以及提示
              }
              else {
                //仅创建起点提示
                scene.add(bulidTxtSprite("起始点", "yellow", intersects[0].point));
              }

              //创建标识圆球
              const geometry = new THREE.SphereGeometry(0.02, 16, 16);
              const sphere = new THREE.Mesh(geometry, material);
              sphere.position.set(intersects[0].point.x, intersects[0].point.y, intersects[0].point.z);


              scene.add(sphere);
              sphereArr.push(sphere);

              pHas = true;
            }

          }

        }
      }

      //通过绘制画板，创建自定义文字的精灵标签
      function bulidTxtSprite(text, style, p) {
        var canvas = document.createElement("canvas");
        canvas.width = 200;
        canvas.height = 60;

        var context = canvas.getContext("2d", { antialias: false, depth: false });
        context.beginPath();
        context.font = "30px Microsoft YaHei";
        //context.fillStyle = "#FF0000";
        //context.fillRect(0, 0, 200, 60);
        context.fillStyle = style;
        context.fillText(text, 40, 50);
        context.fill();
        context.stroke();

        var txtSprite = new THREE.SpriteMaterial({
          map: new THREE.CanvasTexture(canvas),
          blendint: THREE.AdditiveBlending
        });

        var s = new THREE.Sprite(txtSprite);
        s.scale.set(0.15, 0.05, 1)
        s.position.set(p.x, p.y + 0.1, p.z);
        return s;
        //return canvas;
      }

      //鼠标点击对象，发生的事件
      function MeshEvent(name) {
        var mc;
        for (var c in meshsConfig) {
          if (meshsConfig[c].MeshName == name) {
            mc = meshsConfig[c];
            break;
          }
        }

        console.log(mc);

        if (mc != null) {
          var index = 0;
          for (var i = 0; i < meshs.length; i++) {
            if (meshs[i].name == mc.MeshName) {
              index = i;
              break;
            }
          }

          if (index > 0) {
            console.log(mc);
            switch (mc.EventID) {
              case 1: //提示信息
                $("#alertTitle").text(decodeURI(mc.MeshTitle));
                $("#alertLab").text(decodeURI(mc.MeshDesc));
                $("#alertBox").show();
                break;
              case 2: //弹出链接
                $("#FrameTitle").text(decodeURI(mc.MeshTitle));
                $("#FrameBox").show();
                $("#FrameDiv").attr("src", mc.EventData);
                break;
              case 3: //变色
                var color = mc.EventData;
                if (mc.EventData.indexOf(",") > 0) {

                  //console.log(meshs[index].index);

                  var arr = color.split(',');
                  if (meshs[index].index >= 0) {
                    if (meshs[index].index >= arr.length - 1) {
                      meshs[index].index = 0;
                    }
                    else {
                      meshs[index].index++;
                    }
                  }
                  else {
                    meshs[index].index = 0;
                  }
                  color = arr[meshs[index].index];
                }
                meshs[index].material.color = new THREE.Color(color);
                break;
              case 4: //变材质

                break;
              case 5: //布尔值
                if (mc.EventData.length > 0) {
                  eval("meshs[" + index + "]." + mc.EventData + " = !meshs[" + index + "]." + mc.EventData);

                  $("#alertTitle").text(decodeURI(mc.MeshTitle));
                  $("#alertLab").text("被暂时隐藏了");
                  $("#alertBox").show();
                  setTimeout(function () {
                    $("#alertBox").fadeOut(3000);
                  }, 1000);

                }
                break;
              case 7: //图片

                break;
              case 8: //动画
                //console.log(mc);
                switch (mc.EventType) {
                  case 0: //无

                    break;
                  case 1: //单向移动

                    break;
                  case 2: //往复移动

                    break;
                  case 3: //单向旋转
                    switch (mc.EventDirection) {
                      case 0://无

                        break;
                      case 1: //X轴
                        meshs[index].rotation.x = mc.EventValue1;
                        meshs[index].updateMatrix();
                        var t = new TWEEN.Tween(meshs[index].rotation);
                        t.to({ x: mc.EventValue2 }, parseInt(mc.EventData));
                        t.start();
                        break;
                      case 2: //Y轴
                        meshs[index].rotation.y = mc.EventValue1;
                        meshs[index].updateMatrix();
                        var t = new TWEEN.Tween(meshs[index].rotation);
                        t.to({ y: mc.EventValue2 }, parseInt(mc.EventData));
                        t.start();
                        break;
                      case 3: //Z轴
                        meshs[index].rotation.z = mc.EventValue1;
                        meshs[index].updateMatrix();
                        var t = new TWEEN.Tween(meshs[index].rotation);
                        t.to({ z: mc.EventValue2 }, parseInt(mc.EventData));
                        t.start();
                        break;
                    }
                    break;
                  case 4: //往复旋转
                    switch (mc.EventDirection) {
                      case 0://无

                        break;
                      case 1: //X轴
                        var tween = new TWEEN.Tween(meshs[index].rotation);
                        if (meshs[index].rotation.x == mc.EventValue1) {
                          tween.to({ x: mc.EventValue2 }, parseInt(mc.EventData));
                        }
                        else {
                          tween.to({ x: mc.EventValue1 }, parseInt(mc.EventData));
                        }
                        tween.start();
                        break;
                      case 2: //Y轴
                        var tween = new TWEEN.Tween(meshs[index].rotation);
                        if (meshs[index].rotation.y == mc.EventValue1) {
                          tween.to({ y: mc.EventValue2 }, parseInt(mc.EventData));
                        }
                        else {
                          tween.to({ y: mc.EventValue1 }, parseInt(mc.EventData));
                        }
                        tween.start();
                        break;
                      case 3: //Z轴
                        var tween = new TWEEN.Tween(meshs[index].rotation);
                        if (meshs[index].rotation.y == mc.EventValue1) {
                          tween.to({ z: mc.EventValue2 }, parseInt(mc.EventData));
                        }
                        else {
                          tween.to({ z: mc.EventValue1 }, parseInt(mc.EventData));
                        }
                        tween.start();
                        break;
                    }

                    break;
                  case 5: //单向缩放

                    break;
                  case 6: //往复缩放

                    break;
                }
                break;
              case 9: //镜头
                var reg = new RegExp("'", "g");
                var str = mc.EventData.replace(reg, "\"");
                //console.log(str);
                var cameraConfig = JSON.parse(str); //str.responseJSON;

                var newP = new THREE.Vector3(cameraConfig.px, cameraConfig.py, cameraConfig.pz);
                var newT = new THREE.Vector3(parseFloat(mc.X), parseFloat(mc.Y), parseFloat(mc.Z));
                //var tween1 = new TWEEN.Tween(camera.position).to(newP, 2000).start();
                //var tween2 = new TWEEN.Tween(controls.target).to(newT, 2000).onUpdate(function () { controls.update(); }).start();
                MoveCamera(newP, newT, camera.position, controls.target, 2000);
                break;
            }
          }
        }
      }

      //移动镜头
      function MoveCamera(newP, newT, cameraP, controlsT, t) {
        new TWEEN.Tween(cameraP).to(newP, t).start();
        new TWEEN.Tween(controlsT).to(newT, t).onUpdate(function () { controls.update(); }).start();
      }

      //移动镜头，并指定焦点
      function MCamera(newP, newR, newT, cameraP, cameraR, controlsT, t) {
        new TWEEN.Tween(cameraP).to(newP, t).start();
        new TWEEN.Tween(cameraR).to(newR, t).start();
        new TWEEN.Tween(controlsT).to(newT, t).onUpdate(function () { controls.update(); }).start();
      }

      //移动镜头，围绕着模型，自动凑近
      // * 此函数需要运算当前镜头与模型的方向关系，以解决方向适应性
      function MoveCameraForMesh(m, mc) {
        var box = new THREE.Box3().setFromObject(m);
        var len = box.max.x - box.min.x;
        var wid = box.max.z - box.min.z;
        var hei = box.max.y - box.min.y;

        var p = new THREE.Vector3(0, 0, 0);
        var cp = box.getCenter(p);

        var scale = 5;

        var px = cp.x > 0 ? cp.x + len * scale : cp.x - len * scale;
        var py = cp.y > 0 ? cp.y + hei * scale : cp.y - hei * scale;
        var pz = cp.z > 0 ? cp.z + wid * scale : cp.z - wid * scale;

        //var newT = new THREE.Vector3(box.min.x + len / 2, box.min.y + hei / 2, box.min.z + wid / 2);

        //console.log(cp);
        //console.log(newT);
        //console.log(newT);

        var newP = new THREE.Vector3(px, py, pz);
        if (mc != null) {
          if (mc.Cx != 0 || mc.Cy != 0 || mc.Cz != 0) {
            newP = new THREE.Vector3(mc.Cx, mc.Cy, mc.Cz);
          }
        }

        MoveCamera(newP, cp, camera.position, controls.target, 2000);
      }

      function GetGroup(part) {
        if (part.IsPart) {
          if (part.IsPartGroup) {
            return part;
          }
          else {
            return GetGroup(part.parent);
          }
        }
        else {
          return part;
        }
      }

      var links = [];
      function GetPartLinks(part) {
        if (part.IsPart) {
          if (part.IsPartGroup) {
            links.push(part);
          }
          else {
            GetPartLinks(part.parent);
            links.push(part);
          }
        }
        else {
          links.push(part)
        }
      }

      function SpanClick() {
        var id = parseInt(this.getAttribute("data-id"));
        var data = this.getAttribute("data-data");
        ModifyShow(1, "", data);
      }

      //双击模型，弹出修改表单
      function ModifyShow(MeshID, MeshName, intersectsObj) {

        console.log(MeshID);
        console.log(MeshName);
        console.log(intersectsObj);

        $("#MeshOtherInfo").css("display", "contents");
        $("#MeshBaseInfo").css("display", "none");


        //防止命中物体的框线
        var selectObj = intersectsObj.object;
        if (selectObj.type == 'LineSegments') {
          selectObj = selectObj.parent;
        }

        //selectObj = GetGroup(selectObj);
        console.log(selectObj);

        links = [];
        GetPartLinks(selectObj);
        //console.log(links);
        //var links = partLink.split(",");

        document.getElementById("PartCrumbs").innerHTML = "";

        if (links.length > 1) {
          for (var i = 0; i < links.length; i++) {
            if (i == links.length - 1) {
              var span = document.createElement("span");
              span.innerText = links[i].name;
              span.className = "s";
              document.getElementById("PartCrumbs").appendChild(span);
            }
            else {
              var iObj = new Object();
              iObj.object = links[i];
              iObj.point = new THREE.Vector3(intersectsObj.point.x, intersectsObj.point.y, intersectsObj.point.z);

              var span = document.createElement("span");
              span.innerText = links[i].name;
              span.setAttribute("data-data", iObj);
              span.setAttribute("data-id", i);
              span.onclick = function () { ModifyShow(MeshID, span.innerText, iObj); };
              document.getElementById("PartCrumbs").appendChild(span);
            }
            if (i < links.length - 1) {
              var span = document.createElement("b");
              span.innerText = " - ";
              document.getElementById("PartCrumbs").appendChild(span);
            }
          }
        }
        else {
          $("#PartCrumbs").append("<span >" + selectObj.name + "</span>");
        }

        MeshName = selectObj.name;

        $("#MeshID").attr("value", MeshID);
        $("#MeshLab").text("#" + MeshID);
        $("#MeshTag").attr("checked", false);
        $("#MeshName").val(MeshName);
        $("#MeshTitle").val("");
        $("#MeshDesc").val("");
        $("#GroupName").val("");
        $("#MaterialType").val("0");
        $("#MeshColor").attr("value", "");
        $("#EventID").val("0");
        $("#EventName").attr("value", "");
        $("#EventType").attr("value", "");
        $("#EventValue1").attr("value", "");
        $("#EventValue2").attr("value", "");
        $("#EventData").attr("value", "");
        $("#EventDirection").val("0");
        var mc;
        if (meshsConfig != null && meshsConfig.length > 0) {
          for (var i = 0; i < meshsConfig.length; i++) {
            //console.log(meshsConfig[i].MeshName + "  " + MeshName);
            if (meshsConfig[i].MeshName == MeshName) {
              mc = meshsConfig[i];
              break;
            }
          }
        }

        //console.log(mc);

        if (mc != null) {
          $("#MeshTag").attr("checked", mc.ShowTag);
          $("#MeshName").val(MeshName);
          $("#MeshTitle").val(decodeURI(mc.MeshTitle));
          $("#MeshDesc").val(decodeURI(mc.MeshDesc));
          $("#GroupName").val(decodeURI(mc.GroupName));
          $("#MaterialExample").val(mc.MaterialExample);
          $("#MeshColor").val(getColor(mc.MeshColor));
          $("#MeshOpacity").val(parseFloat(mc.Opacity));
          $("#MeshShininess").val(parseFloat(mc.Shininess));

          $("#MaterialType").val(mc.MaterialType);
          $("#FaceType").val(mc.FaceType);
          $("#LoopType").val(mc.LoopType);
          $("#RotateType").val(mc.RotateType);

          $("#EventID").val(mc.EventID);
          $("#EventName").attr("value", mc.EventName);
          $("#EventType").val(mc.EventType);
          $("#EventValue1").attr("value", mc.EventValue1);
          $("#EventValue2").attr("value", mc.EventValue2);
          $("#EventData").attr("value", mc.EventData);
          $("#EventDirection").val(mc.EventDirection);


          var mapInfo = MapDict[MeshName];
          if (mapInfo != undefined) {
            console.log(mapInfo);
            var mapArr = mapInfo.split(',');
            var mapFile = mapArr[0];
            var repeatS = parseFloat(mapArr[1]);
            var repeatT = parseFloat(mapArr[2]);

            $("#TextureTxt").val(mapFile);
            $("#RepeatSBox").val(repeatS);
            $("#RepeatTBox").val(repeatT)
          }

          ModifyMenuClick(document.getElementById("tabLab-" + (mc.EventID + 1)).childNodes[0]);

          switch (mc.EventID) {
            case 0: //无

              break;
            case 1: //提示
              $("#InfoTxt").val(mc.EventData);
              break;
            case 2: //链接
              $("#LinkTxt").val(mc.EventData);
              break;
            case 3: //变色
              $("#ColorBox1").val(mc.EventData);
              break;
            case 4: //变材质
              $("#MaterialList").val(mc.EventValue1);
              $("#MaterialColor").val(mc.EventData);
              break;
            case 5: //开关
              if (mc.EventValue1 < 2) {
                $("#VisibleRadio").attr("checked", true);
              }
              else {
                $("#OtherRadio").attr("checked", true);
              }
              break;
            case 6: //变量

              break;
            case 7: //图片

              break;
            case 8: //动画
              $("#EventType").val(mc.EventType);
              $("#EventValue1").val(mc.EventValue1);
              $("#EventValue2").val(mc.EventValue2);
              $("#EventDirection").val(mc.EventDirection);
              break;
            case 9: //镜头
              var str = mc.EventData.replace(reg, "\"");
              var cameraConfig = JSON.parse(str);

              $("#Cx").val(cameraConfig.px);
              $("#Cy").val(cameraConfig.py);
              $("#Cz").val(cameraConfig.pz);

              $("#Px").val(mc.Cx);
              $("#Px").val(mc.Cy);
              $("#Px").val(mc.Cz);
              break;
            case 10: //指令
              $("#CmdList").val(mc.EventType);
              break;
          }
        }

        $("#Px").val(intersectsObj.point.x);
        $("#Py").val(intersectsObj.point.y);
        $("#Pz").val(intersectsObj.point.z);

        $("#ModifyBox").show();
      }
      //#endregion

      //#region 表单fm：模型修改

      $("#ModifyCloseBox").click(function () { $("#ModifyBox").hide(); });

      $("#SaveMeshBaseBtn").click(function () {
        $("#ModifyBox").hide();

        var jData = {
          "MeshID": $("#MeshID").val(),
          "SceneID": SceneID,
          "MeshName": $("#MeshName").val(),
          "MeshTitle": $("#MeshTitle").val(),
          "MeshDesc": $("#MeshDesc").val(),
          "ShowTag": $("#MeshTag").is(":checked"),
          "GroupName": $("#GroupName").val()
        };

        jh.SaveEntity("/Service/MeshsConfig.asmx/SaveMeshConfigBase", jData);
      });

      $("#ColorAddBtn").click(function () {
        var index = $("panel3").childElementCount;
        this.parentNode.insertAdjacentElement("beforeBegin", pf.CreateColor("ColorBox" + index, "颜色", 2));
      });

      $("#HideMesh").click(function () {
        //console.log(oldObj);
        $("#ModifyBox").hide();
        oldObj.visible = false;
      });

      $("#DelMeshConfig").click(function () {
        $("#ModifyBox").hide();
        var jData = {
          "MeshID": $("#MeshID").val()
        };

        jh.DelEntity("/Service/MeshsConfig.asmx/DelMeshConfig", jData);
      });

      $("#SaveMeshConfig").click(function () {
        $("#ModifyBox").hide();

        var TheEventID = parseInt($("#myTab .active")[0].id.replace("tabLab-", ""));

        TheEventID -= 1;

        console.log(TheEventID);

        //alert($("#RepeatSBox").val());

        var jData = {
          "MeshID": $("#MeshID").val(),
          "SceneID": SceneID,
          "MeshName": $("#MeshName").val(),
          "MeshTitle": $("#MeshTitle").val(),
          "MeshDesc": $("#MeshDesc").val(),
          "MaterialExample": $("#MaterialExample").val(),
          "MaterialData": "{ color: " + $("#MeshColor").val() + ", shininess: " + $("#MeshShininess").val() + ", opacity: " + $("#MeshOpacity").val() + ", transparent: true }",
          "MaterialType": $("#MaterialType").val(),
          "FaceType": $("#FaceType").val(),
          "LoopType": $("#LoopType").val(),
          "RotateType": $("#RotateType").val(),
          "EventID": TheEventID,
          "EventName": "",
          "EventType": $("#EventType").val(),
          "EventValue1": $("#EventValue1").val(),
          "EventValue2": $("#EventValue2").val(),
          "EventData": "",
          "EventDirection": $("#EventDirection").val(),
          "X": $("#Px").val(),
          "Y": $("#Py").val(),
          "Z": $("#Pz").val(),
          "ShowTag": $("#MeshTag").is(":checked"),
          "Cx": $("#Cx").val(),
          "Cy": $("#Cy").val(),
          "Cz": $("#Cz").val(),
          "GroupName": $("#GroupName").val(),
          "Texture": $("#TextureTxt").val(),
          "RepeatS": parseFloat($("#RepeatSBox").val()),
          "RepeatT": parseFloat($("#RepeatTBox").val())
        };

        if (jData.EventType.length <= 0) jData.EventType = 0;
        if (jData.EventValue1.length <= 0) jData.EventValue1 = 0;
        if (jData.EventValue2.length <= 0) jData.EventValue2 = 0;

        if (jData.X.length <= 0) jData.X = 0;
        if (jData.Y.length <= 0) jData.Y = 0;
        if (jData.Z.length <= 0) jData.Z = 0;

        if (jData.Cx.length <= 0) jData.Cx = 0;
        if (jData.Cy.length <= 0) jData.Cy = 0;
        if (jData.Cz.length <= 0) jData.Cz = 0;

        if (Number.isNaN(jData.RepeatS)) jData.RepeatS = 1;
        if (Number.isNaN(jData.RepeatT)) jData.RepeatT = 1;

        switch (TheEventID) {
          case 0: //无
            jData.EventType = 0;
            jData.EventValue1 = 0;
            jData.EventValue2 = 0;
            jData.EventData = "";
            jData.EventDirection = 0;
            break;
          case 1: //提示
            jData.EventType = 0;
            jData.EventValue1 = 0;
            jData.EventValue2 = 0;
            jData.EventData = $("#InfoTxt").val();
            jData.EventDirection = 0;
            break;
          case 2: //链接
            jData.EventType = 0;
            jData.EventValue1 = 0;
            jData.EventValue2 = 0;
            jData.EventData = $("#LinkTxt").val();
            jData.EventDirection = 0;
            break;
          case 3: //变色
            jData.EventType = 0;
            jData.EventValue1 = 0;
            jData.EventValue2 = 0;
            jData.EventData = $("#ColorBox1").val();
            jData.EventDirection = 0;
            break;
          case 4: //变材质
            jData.EventType = 0;
            jData.EventValue1 = $("#MaterialList").val();
            jData.EventValue2 = 0;
            jData.EventData = $("#MaterialColor").val();
            jData.EventDirection = 0;
            break;
          case 5: //开关
            jData.EventType = 0;
            jData.EventValue1 = 0;
            jData.EventValue2 = 0;
            jData.EventData = "";
            jData.EventDirection = 0;
            if ($("#VisibleRadio").is(":checked")) {
              jData.EventValue1 = 1;
            }
            if ($("#OtherRadio").is(":checked")) {
              jData.EventValue1 = 2;
            }
            break;
          case 6: //变量
            jData.EventType = 0;
            jData.EventValue1 = 0;
            jData.EventValue2 = 0;
            jData.EventData = "";
            jData.EventDirection = 0;
            break;
          case 7: //图片
            jData.EventType = 0;
            jData.EventValue1 = 0;
            jData.EventValue2 = 0;
            jData.EventData = "ShowTag";
            jData.EventDirection = 0;
            break;
          case 8: //动画
            jData.EventType = $("#EventType").val();
            jData.EventValue1 = $("#EventValue1").val();
            jData.EventValue2 = $("#EventValue2").val();
            jData.EventData = "";
            jData.EventDirection = $("#EventDirection").val();
            break;
          case 9: //镜头
            jData.EventType = 0;
            jData.EventValue1 = 0;
            jData.EventValue2 = 0;
            jData.EventData = "{ 'px':" + $("#Cx").val() + ", 'py':" + $("#Cy").val() + ", 'pz':" + $("#Cz").val() + " }";
            jData.EventDirection = 0;

            jData.Cx = $("#Px").val();
            jData.Cy = $("#Px").val();
            jData.Cz = $("#Px").val();

            break;
          case 10: //指令
            jData.EventType = $("#CmdList").val();
            jData.EventValue1 = 0;
            jData.EventValue2 = 0;
            jData.EventData = "";
            jData.EventDirection = 0;
            break;
        }

        jh.SaveEntity("/Service/MeshsConfig.asmx/SaveMeshConfig", jData);

        for (var i = 0; i < meshs.length; i++) {
          if (meshs[i].name == jData.MeshName) {
            meshs[i].title = jData.MeshTitle;
            meshs[i].group = jData.GroupName;
            break;
          }
        }

        var nv = tb.ProductMeshNav(meshs,
          ModeSwitch,

          //模型显隐
          function (obj) {
            var m;
            var meshName = this.getAttribute("mesh");
            for (var i = 0; i < meshs.length; i++) {
              if (meshs[i].name == meshName) {
                m = meshs[i];
                break;
              }
            }
            m.visible = !m.visible;
            if (m.visible) {
              this.setAttribute("class", "fa fa-eye")
              obj.target.parentNode.setAttribute("class", "");
            }
            else {
              this.setAttribute("class", "fa fa-eye-slash")
              obj.target.parentNode.setAttribute("class", "s");
            }
            //console.log(m);
          },

          //镜头转到模型
          function (obj) {
            //console.log(obj);

            //console.log(obj.srcElement.mesh);
            var m;
            var meshName = this.getAttribute("mesh");
            for (var i = 0; i < meshs.length; i++) {
              if (meshs[i].name == meshName) {
                m = meshs[i];
                break;
              }
            }
            var mc;
            if (m.tag > 0) {
              for (var c in meshsConfig) {
                if (meshsConfig[c].MeshName == m.name) {
                  mc = meshsConfig[c];
                  break;
                }
              }
            }
            //console.log($("#AnimationBox").is(":visible"));
            if ($("#AnimationBox").is(":visible")) {
              var p = m.name;
              var con = $("#AnimationTitle").val();
              if (con.length > 0) {
                con += ',';
              }
              $("#AnimationTitle").val(con + p);


              switch ($("#AnimationStyle").val()) {
                case '0'://移动
                  //console.log(0);
                  switch ($("#AnimationArouse").val()) {
                    case '0': //x
                      $("#BeginValue").val(m.position.x);
                      break;
                    case '1': //y
                      $("#BeginValue").val(m.position.y);
                      break;
                    case '2': //z
                      $("#BeginValue").val(m.position.z);
                      break;
                  }


                  break;
                case '1'://缩放
                  //console.log(1);
                  switch ($("#AnimationArouse").val()) {
                    case '0': //x
                      $("#BeginValue").val(m.scale.x);
                      break;
                    case '1': //y
                      $("#BeginValue").val(m.scale.y);
                      break;
                    case '2': //z
                      $("#BeginValue").val(m.scale.z);
                      break;
                  }

                  break;
                case '2'://旋转
                  //console.log(2);
                  switch ($("#AnimationArouse").val()) {
                    case '0': //x
                      $("#BeginValue").val(m.rotation.x);
                      break;
                    case '1': //y
                      $("#BeginValue").val(m.rotation.y);
                      break;
                    case '2': //z
                      $("#BeginValue").val(m.rotation.z);
                      break;
                  }

                  break;

              }
            }
            else {

              MoveCameraForMesh(m, mc);
            }
          },

          //模型编辑
          function MeshEdit() {
            var m;
            var meshName = this.getAttribute("mesh");
            for (var i = 0; i < meshs.length; i++) {
              if (meshs[i].name == meshName) {
                m = meshs[i];
                break;
              }
            }
            var mc;
            if (m != null) {
              if (meshsConfig != null) {
                for (var i = 0; i < meshsConfig.length; i++) {
                  if (meshsConfig[i].MeshName == m.name) {
                    mc = meshsConfig[i];
                    break;
                  }
                }
              }
            }
            //console.log(meshName);
            //console.log(m.name);
            //console.log(mc);

            $("#MeshBaseInfo").css("display", "contents");
            $("#MeshOtherInfo").css("display", "none");

            var MeshID = 0;
            if (m.tag > 0) {
              MeshID = m.tag;
            }

            //ModifyShow(MeshID, m.name, mc);

            $("#MeshID").attr("value", MeshID);
            $("#MeshLab").text("#" + MeshID);
            $("#MeshTag").attr("checked", false);
            $("#MeshName").val(m.name);
            $("#MeshTitle").val("");
            $("#MeshDesc").val("");
            $("#GroupName").val("");

            if (mc != null) {
              $("#MeshTag").attr("checked", mc.ShowTag);
              $("#MeshTitle").val(decodeURI(mc.MeshTitle));
              $("#MeshDesc").val(decodeURI(mc.MeshDesc));
              $("#GroupName").val(decodeURI(mc.GroupName));
            }

            $("#ModifyBox").show();
          },

          //整组模型显隐
          function GroupToggle(obj) {
            //var m;
            var ms = [];
            var groupName = this.getAttribute("group");
            //console.log(groupName);
            for (var i = 0; i < meshs.length; i++) {
              if (meshs[i].isMesh) {
                if (groupName == "") {
                  //console.log(meshs[i].group);
                  if (meshs[i].group == null || meshs[i].group == undefined || meshs[i].group == groupName) {
                    ms.push(meshs[i]);
                  }
                }
                else {
                  if (meshs[i].group == groupName) {
                    ms.push(meshs[i]);
                  }
                }
              }
            }

            //console.log(ms);

            var groupVisible = this.getAttribute("class") == "fa fa-eye";
            if (!groupVisible) {
              this.setAttribute("class", "fa fa-eye")
              obj.target.parentNode.setAttribute("class", "");
              for (var i = 0; i < ms.length; i++) {
                ms[i].visible = true;
              }
            }
            else {
              this.setAttribute("class", "fa fa-eye-slash")
              obj.target.parentNode.setAttribute("class", "s");
              for (var i = 0; i < ms.length; i++) {
                ms[i].visible = false;
              }
            }
            //console.log(m);
          },

          //隐藏标识
          function () {
            TagEnable = !TagEnable;
            $("#tagBtn").text(!TagEnable ? "隐藏标识" : "显示标识");

            for (var i = 0; i < sprites.length; i++) {
              sprites[i].visible = !TagEnable;
            }
          },

          //隐藏命名对象
          function () {
            for (var i = 0; i < meshs.length; i++) {
              if (BulidIsHide) {
                meshs[i].visible = true;
              }
              else if (meshs[i].name.length > 0 && BaseArea.indexOf(meshs[i].name) < 0) {
                meshs[i].visible = false;
              }
            }
            for (var i = 0; i < sprites.length; i++) {
              sprites[i].visible = BulidIsHide;
            }

            $("#hideBtn").text(BulidIsHide ? "隐藏命名对象" : "显示命名对象");
            BulidIsHide = !BulidIsHide;
          },

          //全部隐藏
          function () { },

          //全部显示
          function () { }
        );
        //window.location.reload(true);

        nv.style.cssText = "position: absolute; background-color: #f0f3f4; z-index: 100; overflow: scroll;";
      });



      $("#EventID").change(function () {
        var id = ($(this).val());
        var str = "";
        console.log(id);
        switch (id) {
          case "0":
            str = "不同的点击事件，填写不同的内容，<a href=\"#\">请参考帮助</a>";
            $("#EventName").attr("disabled", true);
            $("#EventType").attr("disabled", true);
            $("#EventValue1").attr("disabled", true);
            $("#EventValue2").attr("disabled", true);
            $("#EventData").attr("disabled", true);
            $("#EventDirection").attr("disabled", true);
            break;
          case "1":
            str = "点击后，将在界面中上部弹出包括【模型描述】的提示框";
            $("#EventName").attr("disabled", true);
            $("#EventType").attr("disabled", true);
            $("#EventValue1").attr("disabled", true);
            $("#EventValue2").attr("disabled", true);
            $("#EventData").attr("disabled", true);
            $("#EventDirection").attr("disabled", true);

            break;
          case "2":
            str = "点击后，将在界面中部弹出指向【数据】的网页地址";
            $("#EventName").attr("disabled", true);
            $("#EventType").attr("disabled", true);
            $("#EventValue1").attr("disabled", true);
            $("#EventValue2").attr("disabled", true);
            $("#EventData").attr("disabled", false);
            $("#EventDirection").attr("disabled", true);

            break;
          case "3":
            str = "点击后，指定【对象名称】的颜色变成【数据】中指定的6字符长的16进制格式颜色<br />如果【对象名称】为空，则改变当前对象<br />如果需要在多个颜色之间切换，如下：#ff0000,#00ff00,#0000ff";
            $("#EventName").attr("disabled", false);
            $("#EventType").attr("disabled", true);
            $("#EventValue1").attr("disabled", true);
            $("#EventValue2").attr("disabled", true);
            $("#EventData").attr("disabled", false);
            $("#EventDirection").attr("disabled", true);

            break;
          case "4":
            str = "点击后，指定【对象名称】的材质变成【类型(参考【材质】数值)】的材质，材质参数填写在【数据】中，该项由专业人士填写";
            $("#EventName").attr("disabled", false);
            $("#EventType").attr("disabled", false);
            $("#EventValue1").attr("disabled", true);
            $("#EventValue2").attr("disabled", true);
            $("#EventData").attr("disabled", false);
            $("#EventDirection").attr("disabled", true);

            break;
          case "5":
            str = "点击后，指定【对象名称】的【数据】属性在真假值之间循环切换，如果【数据】属性为空，则将【对象名称】当做变量名";
            $("#EventName").attr("disabled", false);
            $("#EventType").attr("disabled", true);
            $("#EventValue1").attr("disabled", true);
            $("#EventValue2").attr("disabled", true);
            $("#EventData").attr("disabled", false);
            $("#EventDirection").attr("disabled", true);

            break;
          case "6":
            str = "点击后，指定【对象名称】被赋与【数值】的结果<br />如果【对象名称】为空，则改变当前对象<br />如果需要在多个【数据】之间切换，如下：0,5,10,0";
            $("#EventName").attr("disabled", false);
            $("#EventType").attr("disabled", true);
            $("#EventValue1").attr("disabled", false);
            $("#EventValue2").attr("disabled", false);
            $("#EventData").attr("disabled", false);
            $("#EventDirection").attr("disabled", true);

            break;
          case "7":
            str = "点击后，指定当前对象的附近上方【以鼠标点击的位置为基准】，添加一个精灵标识，显示【命名】文字";
            $("#EventName").attr("disabled", true);
            $("#EventType").attr("disabled", true);
            $("#EventValue1").attr("disabled", true);
            $("#EventValue2").attr("disabled", true);
            $("#EventData").attr("disabled", true);
            $("#EventDirection").attr("disabled", true);

            break;
          case "8":
            str = "点击后，指定【对象名称】进行【类型】的基本动画操作，【数值】表示动画时长，【数据】表示动画距离";
            $("#EventName").attr("disabled", false);
            $("#EventType").attr("disabled", false);
            $("#EventValue1").attr("disabled", false);
            $("#EventValue2").attr("disabled", false);
            $("#EventData").attr("disabled", false);
            $("#EventDirection").attr("disabled", false);

            break;
          case "9":
            str = "点击后，镜头转向特定位置，请将坐标参数填写在【数据】中，例如：<br />{ px:0, py:0, pz:0 }<br />镜头的追踪点将是鼠标点击的位置，注意调整";
            $("#EventName").attr("disabled", true);
            $("#EventType").attr("disabled", true);
            $("#EventValue1").attr("disabled", true);
            $("#EventValue2").attr("disabled", true);
            $("#EventData").attr("disabled", false);
            $("#EventDirection").attr("disabled", true);


            $("#EventData").attr("value", "{ \"px\":" + camera.position.x.toFixed(2) + ", \"py\":" + camera.position.y.toFixed(2) + ", \"pz\":" + camera.position.z.toFixed(2) + " }");
            break;
        }

        $("#EventPrompt").html(str);
      });



      //#endregion

      //#region 表单fs：工具栏 产品设置

      function ModelSetup() {
        if ($("#SceneSetupBox").is(":visible")) {
          $("#SceneSetupBox").hide();
        }
        else {
          $("#SceneTitleTxt").val(SceneTitle);

          $("#SceneSetupBox").show();
        }
      }

      var fs = pf.CreateForm("SceneSetupBox", "场景设置", "配置场景类型、功能以及初始镜头", 600, 120);
      fs.appendChild(pf.CreateHiddenValue("SceneID", SceneID));

      fs.appendChild(pf.CreateTxtAndID("SceneTitleLab", "SceneTitleTxt", "场景标题", 8, 60));
      fs.appendChild(pf.CreateColor("BackColorBox", "背景色", 2, SceneBackColor));
      fs.appendChild(pf.CreateSelect("SceneUnitBox", "比例", 2, "毫米,厘米,分米,米,十米,百米,千米,万米", SceneUnit, false));

      fs.appendChild(pf.CreateSelectLab("SceneTypeLab", "SceneTypeBox", "场景类型", 5, 60, "营区模型,建筑内部,产品展示,教学慕课", SceneType));
      fs.appendChild(pf.CreateSelect("SkyBox", "场景天空", 3, "无,清晨,晴朗,黄昏,树荫,银河,星空,月夜", SceneSky));

      fs.appendChild(pf.CreateCheck("ShowFPS", "FPS", 2, SceneShowFPS));
      fs.appendChild(pf.CreateCheck("PolarAngle", "仰角", 2, ScenePolarAngle));
      //fs.appendChild(pf.CreateCheck("ShowLight", "调光", 2, SceneShowLight));

      fs.appendChild(pf.CreateTxtAndID("RotateLab", "RotateTxt", "场景旋转：0无，1顺时针，-1逆时针", 8, 60, false, SceneRotate));
      fs.appendChild(pf.CreateCheck("ShowRole", "测距", 2, SceneShowRole));
      fs.appendChild(pf.CreateCheck("FrameLineBox", "边框线", 2, SceneFrameLine));

      fs.appendChild(pf.CreateTxtAndID("DampingLab", "DampingTxt", "镜头阻尼：0无，0.05为默认", 8, 60, false, SceneDamping));
      fs.appendChild(pf.CreateCheck("BulidTree", "种植", 2, SceneBulidTree));
      fs.appendChild(pf.CreateCheck("GridBox", "网格", 2, SceneGrid));


      fs.appendChild(pf.CreateTxtAndID("CameraConfigLab", "CameraConfigBox", "镜头配置", 10, 60, false, CameraConfig));
      fs.appendChild(pf.CreateBtn("CameraConfigBtn", "获取", 2, 1, function () {
        var config = "rx : " + camera.rotation.x + ", ry : " + camera.rotation.y + ", rz : " + camera.rotation.z + ", px : " + camera.position.x + ", py : " + camera.position.y + ", pz :" + camera.position.z + ", tx : " + controls.target.x + ", ty : " + controls.target.y + ", tz : " + controls.target.z;
        $("#CameraConfigBox").val(config);
      }));

      fs.appendChild(pf.CreateRangeAndID("AmbientLightLab", "AmbientLightTxt", "环境光", 4, 0, 5, 60, 0.1, AmbientLight, function (obj) {
        //console.log(obj.target.value);
        $("#AmbientLightLab").text("环境光:" + obj.target.value);
        ambientLight.intensity = obj.target.value
      }, function () {
        $("#SceneSetupBox").css({ "opacity": "0.3" });
      }, function () {
        $("#SceneSetupBox").css({ "opacity": "1" });
      }));
      fs.appendChild(pf.CreateRange("PointLightLab", "PointLightTxt", "点光", 3, 0, 5, 0.1, PointLight, function (obj) {
        //console.log(obj.target.value);
        $("#PointLightLab").text("点光:" + obj.target.value);
        pointLight.intensity = obj.target.value;
      }, function () {
        $("#SceneSetupBox").css({ "opacity": "0.3" });
      }, function () {
        $("#SceneSetupBox").css({ "opacity": "1" });
      }));

      fs.appendChild(pf.CreateBtnEmpty(4));
      fs.appendChild(pf.CreateBtnEmpty(4));
      fs.appendChild(pf.CreateBtn("SaveModelInfoBtn", "保存", 4, 1, function () {
        $("#SceneSetupBox").hide();

        var sceneConfig = "BackColor : " + $("#BackColorBox").val() + ", PolarAngle : " + $("#PolarAngle").prop("checked") + ", ShowFPS : " + $("#ShowFPS").prop("checked") + ", ShowLight : " + $("#ShowLight").prop("checked") + ", ShowRole : " + $("#ShowRole").prop("checked") + ", FrameLine : " + $("#FrameLineBox").prop("checked") + ", BulidTree : " + $("#BulidTree").prop("checked") + ", Grid : " + $("#GridBox").prop("checked") + ", Rotate : " + $("#RotateTxt").val() + ", Damping : " + $("#DampingTxt").val() + ", Sky : " + $("#SkyBox").val() + ", Unit : " + $("#SceneUnitBox").val() + ", AmbientLight : " + $("#AmbientLightTxt").val() + ", PointLight : " + $("#PointLightTxt").val();

        var jData = {
          "SceneID": $("#SceneID").val(),
          "SceneTitle": $("#SceneTitleTxt").val(),
          "SceneType": $("#SceneTypeBox").val(),
          "UserID": TheUserID,
          "UserName": TheUserName,
          "SceneConfig": sceneConfig,
          "CameraConfig": $("#CameraConfigBox").val(),
          "ModelSize": ModelSize,
          "State": State,
          "ScreenID": ScreenID
        };

        //console.log(jData);

        jh.SaveEntityAsync("/Service/IsoScenes.asmx/SaveIsoScene", jData);

        window.location.reload(true);

      }));
      document.body.appendChild(fs);

      //#endregion

      //#region 场景事件：演示

      function StepDel(id) {
        var jData = { "StepID": id };
        jh.SaveEntityReturn("/Service/Steps.asmx/DelStep", jData, ReloadStep);
        alert("已删除！");
      }

      function StepSetup() { }

      var StepIsPlay = false;
      var StepIsPause = false;
      var StepPlayClock = 0.0;
      var StepPlayDuration = 5;

      //连续播放场景事件
      function StepPlayInit() {
        //初始化所有事件
        StepPlayClock = 0;
        StepPlayDuration = 5;


        if (Steps.length > 0) {
          StepPlayDuration = 0;
          for (var i = 0; i < Steps.length; i++) {
            Steps[i].IsPlay = false;
            Steps[i].IsClose = false;
            var duration = Steps[i].BeginTime + Steps[i].TimeLength;
            if (duration > StepPlayDuration) {
              StepPlayDuration = duration;
            }
          }
        }

        StepIsPlay = true;
        StepIsPause = false;
        //启动定时器
        StepPlayTime();
      }

      function StepPlayTime() {
        if (!StepIsPlay) return;

        if (!StepIsPause) {
          StepPlayClock += 0.1;

          if (StepPlayClock > StepPlayDuration) {
            //全剧终
            return;
          }

          StepPlayMethod();
        }

        setTimeout(StepPlayTime, 100);
      }

      function StepPlayMethod() {
        console.log(StepPlayClock);

        for (var i = 0; i < Steps.length; i++) {
          var step = Steps[i];
          if (!step.IsPlay) {
            if (step.BeginTime < StepPlayClock + 1) {
              step.IsPlay = true;
              switch (step.EventType) {
                case 0:
                  StepIsPause = true;
                  $("#WaitTips").show();
                  break;
                case 1:
                  StepPlay1(step);
                  break;
                case 2:
                  StepPlay2(step);
                  break;
                case 3:
                  StepPlay3(step);
                  break;
                case 4:
                  StepPlay4(step);
                  break;
                case 5:
                  StepPlay5(step);
                  break;
              }
            }
          }
          else {
            if (step.BeginTime + step.TimeLength < StepPlayClock && !step.IsClose) {
              step.IsClose = true;
              switch (step.EventType) {
                case 5:
                  StepClose5(step);
                  break;
              }
            }
          }
        }
      }

      //#endregion

      //#region 表单f0：右侧栏 暂停等待

      $("#WaitTipsBtn").click(function () {
        StepIsPause = false;
        $("#WaitTips").fadeOut('slow');
      });

      function WaitSave() {
        if ($("#WaitSaveBox").is(":visible")) {
          $("#WaitSaveBox").hide();
        }
        else {
          $("#WaitSaveBox").show();
        }
      }

      function StepClick0(id) {
        //console.log(id);
        $("#WaitTips").show();
        setTimeout(function () {
          $("#WaitTips").fadeOut('slow');
        }, 2000);
      }

      function StepEdit0(id) {
        if ($("#WaitSaveBox").is(":visible")) {
          $("#WaitSaveBox").hide();
        }
        else {
          var step = GetStep(id);
          $("#StepID").attr("value", step.StepID);
          $("#BeginTime0").attr("value", step.BeginTime);
          $("#Caption0").attr("value", step.Caption);
          $("#WaitSaveBox").show();
        }
      }

      var f0 = pf.CreateForm("WaitSaveBox", "暂停等待", "在当前场景中插入一个暂停等待，直到用户点击后，才继续播放。", 600);
      f0.appendChild(pf.CreateHidden("StepID"));
      f0.appendChild(pf.CreateTxt("BeginTime0", "开始时间(0-7200秒)", 4));
      f0.appendChild(pf.CreateTxt("Caption0", "动作标题", 4));
      f0.appendChild(pf.CreateBtn("WaitSaveBtn", "保存", 4, 1, function () {
        $("#WaitSaveBox").hide();

        var jData = {
          "StepID": 0,
          "SceneID": SceneID,
          "BeginTime": parseInt("0" + $("#BeginTime0").val()),
          "TimeLength": 0,
          "OrderNum": Steps.length,
          "EventType": 0,
          "Style": 0,
          "Arouse": 0,
          "Parameter": "",
          "BeginValue": 0,
          "EndValue": 0,
          "Caption": $("#Caption0").val()
        };

        jh.SaveEntityReturn("/Service/Steps.asmx/SaveStep", jData, ReloadStep);
      }));

      document.body.appendChild(f0);

      //#endregion

      //#region 表单f1：右侧栏 模型显示

      function StepAddStageToggle() {
        if ($("#StageToggle").is(":visible")) {
          $("#StageToggle").hide();
        }
        else {
          var num = 0;
          for (var i = 0; i < meshs.length; i++) {
            if (!meshs[i].visible) num++;
          }
          if (num > 0) {
            $("#StageToggleNum").text("共有 " + meshs.length + "个模型对象，隐藏了" + num + "个。");
          }
          else {
            $("#StageToggleNum").text("共有 " + meshs.length + "个模型对象，全部处于显示状态！请在左侧栏进行设置。");
          }
          $("#StepID").attr("value", 0);
          $("#StageToggle").show();
        }
      }

      function GetStep(id) {
        var step;
        for (var i = 0; i < Steps.length; i++) {
          if (Steps[i].StepID == id) {
            step = Steps[i];
            break;
          }
        }
        return step;
      }

      function StepPlay1(step) {
        var par = decodeURIComponent(step.Parameter);
        var hMesh = par.split(",");
        for (var i = 0; i < meshs.length; i++) {
          meshs[i].visible = true;
          for (var j = 0; j < hMesh.length; j++) {
            if (meshs[i].name == hMesh[j]) {
              meshs[i].visible = false;
              break;
            }
          }
        }
      }

      function StepStage1(id) {
        var num = 0;
        var step = GetStep(id);

        StepPlay1(step);

        for (var i = 0; i < meshs.length; i++) {
          if (!meshs[i].visible) num++;
        }
        if (num > 0) {
          $("#StageToggleNum").text("共有 " + meshs.length + "个模型对象，隐藏了" + num + "个。");
        }
        else {
          $("#StageToggleNum").text("共有 " + meshs.length + "个模型对象，全部处于显示状态！请在左侧栏进行设置。");
        }

        return step;
      }

      function StepClick1(id) {
        if ($("#StageToggle").is(":visible")) {
          $("#StageToggle").hide();
        }
        else {
          StepStage1(id);
        }
      }

      function StepEdit1(id) {
        if ($("#StageToggle").is(":visible")) {
          $("#StageToggle").hide();
        }
        else {
          var step = StepStage1(id);

          $("#StepID").attr("value", step.StepID);
          $("#BeginTime1").attr("value", step.BeginTime);
          $("#TimeLength1").attr("value", step.TimeLength);
          $("#StepStyle").attr("value", step.Style);
          $("#Arouse").attr("value", step.Arouse);
          $("#StageToggle").show();
        }
      }

      var f1 = pf.CreateForm("StageToggle", "模型显示", "将左侧栏【模型导航】中的显示隐藏设置，保存到当天场景中。", 600);
      f1.appendChild(pf.CreateHidden("StepID"));
      f1.appendChild(pf.CreateTitle("当前模型显示情况：", "#", "StageToggleNum"));
      f1.appendChild(pf.CreateTxt("BeginTime1", "开始时间(0-7200秒)", 4));
      f1.appendChild(pf.CreateRange("TimeLengthLab", "TimeLength1", "持续时长(5秒)", 4, 1, 60, 1, 5, function (obj) { $("#TimeLengthLab").text("持续时长(" + obj.target.value + "秒)"); }, function () { }, function () { }));
      f1.appendChild(pf.CreateBtnEmpty(4));
      f1.appendChild(pf.CreateLab("【立即隐藏】表示在场景切换时，被选择隐藏的模型就不会显示了"));
      //开始时间，持续时长
      f1.appendChild(pf.CreateSelect("StepStyle", "隐藏形式", 4, "立即隐藏"));
      f1.appendChild(pf.CreateRange("AnimationTimeLab", "AnimationTime", "动画时间(5秒)", 4, 0, 10, 1, 5, function (obj) { $("#AnimationTimeLab").text("动画时间(" + obj.target.value + "秒)"); }, function () { }, function () { }));
      f1.appendChild(pf.CreateSelect("Arouse", "激发形式", 4, "顺序执行,与上同时,2秒之后,5秒之后,10秒之后"));
      f1.appendChild(pf.CreateBtnEmpty(4));
      f1.appendChild(pf.CreateBtnEmpty(4));
      f1.appendChild(pf.CreateBtn("SaveStageToggleBtn", "保存", 4, 1, function () {
        $("#StageToggle").hide();

        var hideMesh = new Array();
        for (var i = 0; i < meshs.length; i++) {
          if (!meshs[i].visible) {
            hideMesh.push(meshs[i].name);
          }
        }
        //alert("保存功能正在设计");
        var jData = {
          "StepID": parseInt("0" + $("#StepID").val()),
          "SceneID": SceneID,
          "BeginTime": parseInt("0" + $("#BeginTime1").val()),
          "TimeLength": parseInt("0" + $("#TimeLength1").val()),
          "OrderNum": Steps.length,
          "EventType": 1,
          "Style": parseInt($("#StepStyle").val()),
          "Arouse": parseInt($("#Arouse").val()),
          "Parameter": hideMesh.join(),
          "BeginValue": 0,
          "EndValue": 0,
          "Caption": ""
        };

        jh.SaveEntityReturn("/Service/Steps.asmx/SaveStep", jData, ReloadStep);
      }));

      document.body.appendChild(f1);

      //#endregion

      //#region 表单f2：右侧栏 镜头轨迹

      function CameraLocusSave() {
        if ($("#CameraLocus").is(":visible")) {
          $("#CameraLocus").hide();
        }
        else {
          $("#PointList").val("");
          $("#CameraLocus").show();
        }
      }

      function StepPlay2(step) {
        switch (step.Style) {

          case 0: //固定镜头
            var reg = new RegExp("　", "g");

            //解决encodeURL时空格变成+号问题
            var par = '{"cs": [ ' + decodeURIComponent(step.Parameter).replace(reg, " ") + ' ]}';

            var cameras = $.parseJSON(par).cs;

            //console.log(cameras);

            if (cameras.length > 0) {
              //var cbs = $.Callbacks();
              var tP = new TWEEN.Tween(camera.position);
              var tR = new TWEEN.Tween(camera.rotation);
              var tT = new TWEEN.Tween(controls.target);
              tT.onUpdate(function () { controls.update(); });
              var newP = new THREE.Vector3(cameras[0].PX, cameras[0].PY, cameras[0].PZ);
              var newR = new THREE.Vector3(cameras[0].RX, cameras[0].RY, cameras[0].RZ);
              var newT = new THREE.Vector3(cameras[0].TX, cameras[0].TY, cameras[0].TZ);
              tP.to(newP, 1000);
              tR.to(newR, 1000);
              tT.to(newT, 1000);
              tP.start();
              tR.start();
              tT.start();
            }
            break;
          case 1: //环绕旋转
            controls.autoRotateSpeed = -12;
            controls.autoRotate = true;
            setTimeout(function () {
              controls.autoRotate = false;
            }, step.TimeLength * 1000);
            console.log(controls.autoRotate);
            console.log(step.TimeLength);

            break;
          case 2: //远近推拉
            var reg = new RegExp("　", "g");

            //解决encodeURL时空格变成+号问题
            var par = '{"cs": [ ' + decodeURIComponent(step.Parameter).replace(reg, " ") + ' ]}';

            var cameras = $.parseJSON(par).cs;

            //console.log(cameras);

            if (cameras.length > 0) {
              //var cbs = $.Callbacks();
              var tP = new Array();
              var tR = new Array();
              var tT = new Array();
              tP[0] = new TWEEN.Tween(camera.position);
              tR[0] = new TWEEN.Tween(camera.rotation);
              tT[0] = new TWEEN.Tween(controls.target);
              tT[0].onUpdate(function () { controls.update(); });

              var newP = new THREE.Vector3(cameras[0].PX, cameras[0].PY, cameras[0].PZ);
              var newR = new THREE.Vector3(cameras[0].RX, cameras[0].RY, cameras[0].RZ);
              var newT = new THREE.Vector3(cameras[0].TX, cameras[0].TY, cameras[0].TZ);
              tP[0].to(newP, 1000).easing(TWEEN.Easing.Sinusoidal.InOut);
              tR[0].to(newR, 1000).easing(TWEEN.Easing.Sinusoidal.InOut);
              tT[0].to(newT, 1000).easing(TWEEN.Easing.Sinusoidal.InOut);

              if (cameras.length > 1) {
                console.log(cameras.length);
                for (var i = 1; i < cameras.length; i++) {
                  tP[i] = new TWEEN.Tween(camera.position);
                  var nP = new THREE.Vector3(cameras[i].PX, cameras[i].PY, cameras[i].PZ);
                  tP[i].to(nP, 1000).easing(TWEEN.Easing.Sinusoidal.InOut);
                  tR[i] = new TWEEN.Tween(camera.rotation);
                  var nR = new THREE.Vector3(cameras[i].RX, cameras[i].RY, cameras[i].RZ);
                  tR[i].to(nR, 1000).easing(TWEEN.Easing.Sinusoidal.InOut);
                  tT[i] = new TWEEN.Tween(controls.target);
                  var nT = new THREE.Vector3(cameras[i].TX, cameras[i].TY, cameras[i].TZ);
                  tT[i].to(nT, 1000).easing(TWEEN.Easing.Sinusoidal.InOut);
                  tT[i].onUpdate(function () { controls.update(); });

                  tP[i - 1].chain(tP[i]);
                  tR[i - 1].chain(tR[i]);
                  tT[i - 1].chain(tT[i]);
                }
              }
              tP[0].start();
              tR[0].start();
              tT[0].start();
            }
            break;
        }
      }

      function StepStage2(id) {
        var num = 0;
        var step = GetStep(id);

        StepPlay2(step);

        return step;
      }

      function StepClick2(id) {
        if ($("#CameraLocus").is(":visible")) {
          $("#CameraLocus").hide();
        }
        else {
          StepStage2(id);
        }
      }

      function StepEdit2(id) {
        if ($("#CameraLocus").is(":visible")) {
          $("#CameraLocus").hide();
        }
        else {
          var step = StepStage2(id);

          $("#StepID").attr("value", step.StepID);
          $("#BeginTime2").text(step.BeginTime);
          $("#TimeLength2").attr("value", step.TimeLength);
          $("#Caption1").text(step.Caption);
          $("#PointList").val(decodeURIComponent(step.Parameter));
          $("#CameraLocus").show();
        }
      }

      var f2 = pf.CreateForm("CameraLocus", "镜头轨迹", "新增多条镜头运行的轨迹，保存到当天场景中。", 600);
      f2.appendChild(pf.CreateTitle("调整当前镜头位置：", "将当前镜头的参数，作为动画效果的参数", "StageToggleNum"));
      f2.appendChild(pf.CreateTxt("BeginTime2", "开始时间(0-7200秒)", 4));
      f2.appendChild(pf.CreateRange("TimeLengthLab2", "TimeLength2", "持续时长(5秒)", 4, 1, 60, 1, 5, function (obj) { $("#TimeLengthLab2").text("持续时长(" + obj.target.value + "秒)"); }, function () { }, function () { }));
      f2.appendChild(pf.CreateBtnEmpty(4));
      f2.appendChild(pf.CreateTxt("Caption1", "动作标题", 4));
      f2.appendChild(pf.CreateSelect("CameraType", "镜头类型", 4, "固定镜头,环绕旋转,远近推拉"));
      f2.appendChild(pf.CreateCheck("CameraCheck", "透视/正交", 3));
      f2.appendChild(pf.CreateCheck("CameraLine", "直线/曲线", 3));
      f2.appendChild(pf.CreateCheck("CameraPoint", "两点/多点", 3));
      f2.appendChild(pf.CreateTextarea("PointList", "镜头位置", 12));
      f2.appendChild(pf.CreateBtn("CameraTop", "顶", 2, 0, function () { }));
      f2.appendChild(pf.CreateBtn("CameraSide", "侧", 2, 0, function () { }));
      f2.appendChild(pf.CreateBtn("CameraFront", "前", 2, 0, function () { }));
      f2.appendChild(pf.CreateBtn("CameraBack", "后", 2, 0, function () { }));
      f2.appendChild(pf.CreateBtn("CameraLeft", "左", 2, 0, function () { }));
      f2.appendChild(pf.CreateBtn("CameraRight", "右", 2, 0, function () { }));
      f2.appendChild(pf.CreateLab("将当前场景的镜头参数添加到位置列表，组成镜头运动轨迹。"));
      f2.appendChild(pf.CreateBtn("PointAddBtn", "添加镜头位置", 4, 1, function () {
        var p = '{ "PX": ' + camera.position.x.toFixed(3) + ', "PY": ' + camera.position.y.toFixed(3) + ', "PZ": ' + camera.position.z.toFixed(3) +
          ', "RX": ' + camera.rotation.x.toFixed(3) + ', "RY": ' + camera.rotation.y.toFixed(3) + ', "RZ": ' + camera.rotation.z.toFixed(3) +
          ', "TX": ' + controls.target.x.toFixed(3) + ', "TY": ' + controls.target.y.toFixed(3) + ', "TZ": ' + controls.target.z.toFixed(3) + ' }\r\n';
        var con = $("#PointList").val();
        if (con.length > 0) {
          con += ',\r\n';
        }
        $("#PointList").val(con + p);
        console.log(p);
      }));

      f2.appendChild(pf.CreateBtnEmpty(4));
      f2.appendChild(pf.CreateBtn("CameraLocusSaveBtn", "保存", 4, 1, function () {
        $("#CameraLocus").hide();

        //alert("保存功能正在设计");
        var jData = {
          "StepID": parseInt("0" + $("#StepID").val()),
          "SceneID": SceneID,
          "BeginTime": parseInt("0" + $("#BeginTime2").val()),
          "TimeLength": parseInt("0" + $("#TimeLength2").val()),
          "OrderNum": Steps.length,
          "EventType": 2,
          "Style": $("#CameraType").is(":checked") ? 1 : 0,
          "Arouse": $("#CameraLine").is(":checked") ? 1 : 0,
          "Parameter": $("#PointList").val(),
          "BeginValue": 0,
          "EndValue": 0,
          "Caption": $("#Caption1").val()
        };

        jh.SaveEntityReturn("/Service/Steps.asmx/SaveStep", jData, ReloadStep);
      }));

      document.body.appendChild(f2);

      //#endregion

      //#region 表单f3：右侧栏 字幕描述

      function HeaderSave() {
        if ($("#HeaderSaveBox").is(":visible")) {
          $("#HeaderBox").hide();
          $("#HeaderSaveBox").hide();
          //window.speechSynthesis.cancel();
        }
        else {
          var text1 = "";
          $("#StepTitle").val(text1);

          $("#HeaderSaveBox").show();
        }
      }

      function StepPlay3(step) {
        var text1 = decodeURIComponent(step.Parameter);
        PlaySpeech(text1, function (time) {
          $("#TimeLength3").val(time).change();
        });
      }

      function StepStage3(id) {
        var num = 0;
        var step = GetStep(id);
        StepPlay3(step);
        return step;
      }

      function StepClick3(id) {
        if ($("#HeaderSaveBox").is(":visible")) {
          $("#HeaderSaveBox").hide();
        }
        else {
          StepStage3(id);
        }
      }

      function StepEdit3(id) {
        if ($("#HeaderSaveBox").is(":visible")) {
          $("#HeaderSaveBox").hide();
        }
        else {
          var step = StepStage3(id);

          $("#StepID").attr("value", step.StepID);
          $("#BeginTime3").text(step.BeginTime);
          $("#TimeLength3").attr("value", step.TimeLength);
          //$("#StepStyle").attr("value", step.Style);
          //$("#Arouse").attr("value", step.Arouse);
          $("#StepTitle").val(decodeURIComponent(step.Parameter));
          $("#HeaderSaveBox").show();
        }
      }

      //播放字幕
      function PlaySpeech(text, c) {
        var u = new SpeechSynthesisUtterance();
        u.text = text;
        u.lang = "zh";
        u.rate = 1.4;
        $("#HeaderTitle").text(text);
        $("#HeaderBox").show();
        u.onend = function (event) {
          c(Math.ceil(event.elapsedTime / 1000));
          $("#HeaderBox").hide();
        }
        window.speechSynthesis.speak(u);
      }

      var f3 = pf.CreateForm("HeaderSaveBox", "字幕描述", "根据模型显示和镜头内容，编写介绍和说明内容，保存到当天场景中。", 600);
      f3.appendChild(pf.CreateTxt("BeginTime3", "开始时间(0-7200秒)", 4));
      f3.appendChild(pf.CreateRange("TimeLengthLab3", "TimeLength3", "持续时长(5秒)", 8, 1, 300, 1, 5, function (obj) { $("#TimeLengthLab3").text("持续时长(" + obj.target.value + "秒)"); }, function () { }, function () { }));
      f3.appendChild(pf.CreateBtnEmpty(4));
      f3.appendChild(pf.CreateTitle("字幕内容可由多行文本组成", "在场景运行时，将每行分别，按照语速逐条显示在界面下方。", "StageToggleNum"));
      f3.appendChild(pf.CreateTextarea("StepTitle", "字幕内容", 12));
      f3.appendChild(pf.CreateBtn("SpeakTestBtn", "测试", 4, 0, function () {
        var text1 = $("#StepTitle").val();

        //.replace("90KVA", "九十千伏安")

        PlaySpeech(text1, function (time) {
          $("#TimeLength3").val(time).change();
        });
      }));
      f3.appendChild(pf.CreateBtnEmpty(4));
      f3.appendChild(pf.CreateBtn("HeaderSaveBoxBtn", "保存", 4, 1, function () {
        $("#HeaderSaveBox").hide();

        //alert("保存功能正在设计");
        var jData = {
          "StepID": parseInt("0" + $("#StepID").val()),
          "SceneID": SceneID,
          "BeginTime": parseInt("0" + $("#BeginTime3").val()),
          "TimeLength": parseInt("0" + $("#TimeLength3").val()),
          "OrderNum": Steps.length,
          "EventType": 3,
          "Style": 0,
          "Arouse": 0,
          "Parameter": $("#StepTitle").val(),
          "BeginValue": 0,
          "EndValue": 0,
          "Caption": ""
        };

        jh.SaveEntityReturn("/Service/Steps.asmx/SaveStep", jData, ReloadStep);
      }));

      document.body.appendChild(f3);

      //#endregion

      //#region 表单f4：右侧栏 动画效果

      function AnimationSave() {
        if ($("#AnimationBox").is(":visible")) {
          $("#AnimationBox").hide();
        }
        else {
          $("#AnimationBox").show();
        }
      }

      function StepPlay4(step) {
        var strs = new Array();
        strs = decodeURIComponent(step.Parameter).split(",");
        //console.log(strs);
        for (var i = 0; i < strs.length; i++) {
          for (var j = 0; j < meshs.length; j++) {
            if (meshs[j].name == strs[i]) {

              switch (step.Style) {
                case 0: //移动
                  var bValue = step.BeginValue;
                  var eValue = step.EndValue;
                  switch (step.Arouse) {
                    case 0: //X轴
                      meshs[j].position.x = bValue;
                      meshs[j].updateMatrix();
                      var t = new TWEEN.Tween(meshs[j].position);
                      t.to({ x: eValue }, 1000);
                      t.start();
                      break;
                    case 1: //Y轴
                      //console.log(meshs[j].name + ": " + meshs[j].position.y);
                      //meshs[j].position.y = bValue;
                      var ev = meshs[j].position.y + eValue;
                      meshs[j].updateMatrix();
                      var t = new TWEEN.Tween(meshs[j].position);
                      t.to({ y: ev }, 1000);
                      t.start();
                      break;
                    case 2: //Z轴
                      meshs[j].position.z = bValue;
                      meshs[j].updateMatrix();
                      var t = new TWEEN.Tween(meshs[j].position);
                      t.to({ z: eValue }, 1000);
                      t.start();
                      break;
                  }
                  break;
                case 1: //缩放

                  break;
                case 2: //旋转
                  var bValue = Math.PI * step.BeginValue / 180;
                  var eValue = Math.PI * step.EndValue / 180;

                  switch (step.Arouse) {
                    case 0: //X轴
                      meshs[j].rotation.x = bValue;
                      meshs[j].updateMatrix();
                      var t = new TWEEN.Tween(meshs[j].rotation);
                      t.to({ x: eValue }, 1000);
                      t.start();
                      break;
                    case 1: //Y轴
                      meshs[j].rotation.y = bValue;
                      meshs[j].updateMatrix();
                      var t = new TWEEN.Tween(meshs[j].rotation);
                      t.to({ y: eValue }, 1000);
                      t.start();
                      break;
                    case 2: //Z轴
                      meshs[j].rotation.z = bValue;
                      meshs[j].updateMatrix();
                      var t = new TWEEN.Tween(meshs[j].rotation);
                      t.to({ z: eValue }, 1000);
                      t.start();
                      break;
                  }

                  break;
              }
              break;

            }
          }
        }
      }

      function StepStage4(id) {
        var num = 0;
        var step = GetStep(id);
        StepPlay4(step);
        return step;
      }

      function StepClick4(id) {
        if ($("#AnimationBox").is(":visible")) {
          $("#AnimationBox").hide();
        }
        else {
          StepStage4(id);
        }
      }

      function StepEdit4(id) {
        if ($("#AnimationBox").is(":visible")) {
          $("#AnimationBox").hide();
        }
        else {
          var step = StepStage4(id);

          $("#StepID").attr("value", step.StepID);
          $("#BeginTime4").attr("value", step.BeginTime);
          $("#TimeLength4").attr("value", step.TimeLength);
          $("#AnimationStyle").attr("value", step.Style);
          $("#AnimationArouse").attr("value", step.Arouse);
          $("#AnimationTitle").val(decodeURIComponent(step.Parameter));
          $("#AnimationBox").show();
        }
      }

      var f4 = pf.CreateForm("AnimationBox", "动画效果", "根据选定的单个、多个模型，统一按轴心进行移动、缩放、旋转操作。", 700, 100);
      f4.appendChild(pf.CreateTxt("BeginTime4", "开始时间(0-7200秒)", 4));
      f4.appendChild(pf.CreateRange("TimeLengthLab4", "TimeLength4", "持续时长(5秒)", 4, 1, 60, 1, 5, function (obj) { $("#TimeLengthLab4").text("持续时长(" + obj.target.value + "秒)"); }, function () { }, function () { }));
      f4.appendChild(pf.CreateTxt("Caption", "动作标题", 4));
      f4.appendChild(pf.CreateSelect("AnimationStyle", "动画类型", 3, "移动,缩放,旋转"));
      f4.appendChild(pf.CreateSelect("AnimationArouse", "动画方向", 3, "X,Y,Z"));
      f4.appendChild(pf.CreateTxt("BeginValue", "起始值(0-9999)", 3));
      f4.appendChild(pf.CreateTxt("EndValue", "终止值(0-9999)", 3));
      f4.appendChild(pf.CreateTitle("选择参与动画的模型", "在左侧模型导航列表中，点击模型的名称，可以添加到以下列表中。", "AnimationNum"));
      f4.appendChild(pf.CreateTextarea("AnimationTitle", "模型", 12));
      f4.appendChild(pf.CreateBtnEmpty(4));
      f4.appendChild(pf.CreateBtnEmpty(4));
      f4.appendChild(pf.CreateBtn("AnimationSaveBox", "保存", 4, 1, function () {
        $("#AnimationBox").hide();

        var jData = {
          "StepID": parseInt("0" + $("#StepID").val()),
          "SceneID": SceneID,
          "BeginTime": parseInt("0" + $("#BeginTime4").val()),
          "TimeLength": parseInt("0" + $("#TimeLength4").val()),
          "OrderNum": Steps.length,
          "EventType": 4,
          "Style": $("#AnimationStyle").val(),
          "Arouse": $("#AnimationArouse").val(),
          "Parameter": $("#AnimationTitle").val(),
          "BeginValue": $("#BeginValue").val(),
          "EndValue": $("#EndValue").val(),
          "Caption": $("#Caption").val()
        };

        jh.SaveEntityReturn("/Service/Steps.asmx/SaveStep", jData, ReloadStep);
      }));

      document.body.appendChild(f4);

      //#endregion

      //#region 表单f5：右侧栏 章节标题

      function SectionSave() {
        if ($("#SectionSaveBox").is(":visible")) {
          $("#SectionSaveBox").hide();
        }
        else {
          $("#SectionSaveBox").show();
        }
      }

      function StepPlay5(step) {
        $("#SCaption").text(decodeURIComponent(step.Caption));
        $("#SSub").text(decodeURIComponent(step.Parameter));
        $("#SectionPlayer").show();
      }

      function StepClose5(step) {
        $("#SectionPlayer").fadeOut('slow');
      }

      function StepStage5(id) {
        var num = 0;
        var step = GetStep(id);
        StepPlay5(step);
        return step;
      }

      function StepClick5(id) {
        if ($("#SectionSaveBox").is(":visible")) {
          $("#SectionSaveBox").hide();
        }
        else {
          StepStage5(id);
        }
      }

      function StepEdit5(id) {
        if ($("#SectionSaveBox").is(":visible")) {
          $("#SectionSaveBox").hide();
        }
        else {
          var step = StepStage5(id);

          $("#StepID").attr("value", step.StepID);
          $("#BeginTime5").attr("value", step.BeginTime);
          $("#TimeLength5").attr("value", step.TimeLength);
          $("#SectionCaption").attr("value", step.Caption);
          $("#SectionTitle").attr("value", step.Parameter);
          $("#SectionSaveBox").show();
        }
      }

      var f5 = pf.CreateForm("SectionSaveBox", "章节标题", "为场景添加简明扼要的章节标题，以及简短的章节概要描述。", 700, 100);
      f5.appendChild(pf.CreateTxt("BeginTime5", "开始时间(0-7200秒)", 4));
      f5.appendChild(pf.CreateRange("TimeLengthLab5", "TimeLength5", "持续时长(5秒)", 4, 1, 60, 1, 5, function (obj) { $("#TimeLengthLab5").text("持续时长(" + obj.target.value + "秒)"); }, function () { }, function () { }));
      f5.appendChild(pf.CreateBtnEmpty(4));
      f5.appendChild(pf.CreateTxt("SectionCaption", "标题", 12));
      f5.appendChild(pf.CreateTextarea("SectionTitle", "描述", 12));
      f5.appendChild(pf.CreateBtnEmpty(4));
      f5.appendChild(pf.CreateBtnEmpty(4));
      f5.appendChild(pf.CreateBtn("SectionSaveBtn", "保存", 4, 1, function () {
        $("#SectionSaveBox").hide();

        var jData = {
          "StepID": parseInt("0" + $("#StepID").val()),
          "SceneID": SceneID,
          "BeginTime": parseInt("0" + $("#BeginTime5").val()),
          "TimeLength": parseInt("0" + $("#TimeLength5").val()),
          "OrderNum": Steps.length,
          "EventType": 5,
          "Style": 0,
          "Arouse": 0,
          "Parameter": $("#SectionTitle").val(),
          "BeginValue": 0,
          "EndValue": 0,
          "Caption": $("#SectionCaption").val()
        };

        jh.SaveEntityReturn("/Service/Steps.asmx/SaveStep", jData, ReloadStep);
      }));

      document.body.appendChild(f5);

      //#endregion

      //#region 表单f6：右侧栏 标签标识

      function TaskSave() {
        if ($("#TaskSaveBox").is(":visible")) {
          $("#TaskSaveBox").hide();
        }
        else {
          $("#TaskSaveBox").show();
        }
      }

      var f6 = pf.CreateForm("TaskSaveBox", "标签标识", "为生产过程设立可明确判定的关键节点，用于标识生产进度，保存到当天场景中。", 700, 100);
      f6.appendChild(pf.CreateTxt("TaskTitle1", "关键生产过程节点", 12));
      f6.appendChild(pf.CreateTxt("TaskTitle2", "基础材料完工节点", 12));
      f6.appendChild(pf.CreateTxt("TaskTitle3", "产品整体装配节点", 12));
      f6.appendChild(pf.CreateTxt("TaskTitle4", "电气调试试验节点", 12));
      f6.appendChild(pf.CreateTxt("TaskTitle5", "涂装、路试、随车工具", 12));
      f6.appendChild(pf.CreateBtnEmpty(4));
      f6.appendChild(pf.CreateBtnEmpty(4));
      f6.appendChild(pf.CreateBtn("TaskSaveBoxBtn", "保存", 4, 1, function () {
        $("#TaskSaveBox").hide();

        alert("保存功能正在设计");
        //var jData = {
        //    "ModelID": $("#ModelID").val(),
        //    "ModelName": $("#ModelName").val(),
        //    "OrderNum": $("#OrderNum").val(),
        //    "PlanBeginDate": planBeginDate,
        //    "PlanEndDate": planEndDate,
        //    "BeginDate": beginDate,
        //    "EndDate": endDate
        //};

        //console.log(jData);

        //jh.SaveEntity("/Service/Models.asmx/SaveModelInfo", jData);
        //jh.SaveModelInfo(jData);
      }));

      document.body.appendChild(f6);

      //#endregion

      //#region 表单fd：可视化数据

      var selectLink;
      var fd = pf.CreateForm("VisualBindBox", "可视化大屏数据绑定", "选择一个已发布的大屏系统，将其可视化图表数据绑定到当前数字孪生项目界面中。", 600);
      fd.appendChild(pf.CreateTree("jstree1", "已发布的数据大屏", ScreenStr, function () {
        $("#VisualBindBtn").attr("disabled", false);
        if (selectLink != null) {
          selectLink.style.backgroundColor = "";
          selectLink.style.color = "";
        }
        selectLink = this;
        selectLink.style.backgroundColor = "#0000FF";
        selectLink.style.color = "#FFFF00";
        //alert(selectLink.innerHTML);
      }));
      fd.appendChild(pf.CreateBtn("VisualBindBtn", "保存", 4, 1, function () {
        //$("#VisualBindBox").hide();

        var jData = {
          "SceneID": SceneID,
          "VisualBind": selectLink.innerHTML
        };

        jh.SaveEntity("/Service/IsoScenes.asmx/VisualBind", jData);

        window.location.reload(true);
      }));

      fd.appendChild(pf.CreateBtn("VisualBindCancelBtn", "取消绑定", 4, 1, function () {
        //$("#VisualBindBox").hide();

        var jData = {
          "SceneID": SceneID,
          "VisualBind": "!"
        };

        jh.SaveEntity("/Service/IsoScenes.asmx/VisualBind", jData);

        window.location.reload(true);
      }));
      document.body.appendChild(fd);

      //#endregion

      //加载期间的Logo动画事件
      function logoCallBack(stage) {
        switch (stage) {
          case 1:
            $("#logo").fadeTo(200, 0.75);
            break;
          case 2:
            $("#logo").fadeTo(200, 0.5);
            break;
          case 3:
            $("#logo").fadeTo(200, 0.25);
            break;
          case 4:
            $("#logo").fadeTo(200, 0, function () {
              $("#logo").hide();
            });
            break;
        }
      }

      //加载第一阶段，页面加载完成
      // * 放在此处是因为怕图表部分的数据引发的错误，导致阶段加载异常
      at.Stage(1, logoCallBack);

      //根据表单配置改变模型
      function ChangeMaterial() {
        MouseSelectMesh.material = ConfigMaterial(
          MouseSelectMesh.material,
          MouseSelectMesh.material.color,
          MouseSelectMesh.material.opacity,
          MouseSelectMesh.material.shininess,
          $('#FaceType').val(),
          $('#MaterialType').val(),
          $('#MaterialExample').val()
        );
      }

      function RepeatChange() {
        try {
          var RepeatS = parseFloat($('#RepeatSBox').val());
          var RepeatT = parseFloat($("#RepeatTBox").val());
          if (Number.isNaN(RepeatS)) RepeatS = 1;
          if (Number.isNaN(RepeatT)) RepeatT = 1;
          MouseSelectMesh.material.map.repeat.set(RepeatS, RepeatT)
        } catch (e) {

        }
      }

      //目录树初始化
      $(document).ready(function () {

        if (ScreenID > 0) {
          jh.LoadEntityList("/Service/IsoScreens.asmx/LoadIsoScreen", LoadScreen, "id=" + ScreenID);
        }

        WindowReSize();

        $('#MaterialExample').change(ChangeMaterial);
        $('#FaceType').change(ChangeMaterial);
        $('#LoopType').change(ChangeMaterial);
        $('#RotateType').change(ChangeMaterial);

        //表单颜色调整
        $('.colorpicker-demo').colorpicker({
          color: $('#MeshColor').val()
        }).on('changeColor', function (ev) {
          $('#MeshColor').val(ev.color.toHex());
          MouseSelectMesh.material.color.setHex(ev.color.toHex().replace("#", "0x"));
        });

        //表单透明度调整
        $('#MeshOpacity').mousemove(function () {
          //console.log($('#MeshOpacity').val());
          MouseSelectMesh.material.transparent = true;
          MouseSelectMesh.material.opacity = parseFloat($('#MeshOpacity').val());
        });

        //表单光照调整
        $('#MeshShininess').mousemove(function () {
          MouseSelectMesh.material.shininess = parseInt($('#MeshShininess').val());
        });

        $('#RepeatSBox').change(RepeatChange);
        $('#RepeatTBox').change(RepeatChange);

        $("#PartBulidClose").click(function () { $("#PartBulidBox").hide(); });


        //$("#PartR").click(ShowPartR);
        //$("#PartR").mousemove(ShowPartR);

        //function ShowPartR() {
        //  var rota = parseFloat($('#PartR').val());
        //  $("#PartLab").text("方向：" + rota + "度");
        //  if (DesignPart != null) {
        //    DesignPart.rotation.y = Math.PI / 180 * rota;
        //  }
        //}

        $('.spinner .btn:first-of-type').on('click', function () {
          $('.spinner input').val(parseInt($('.spinner input').val(), 10) + 1);
        });
        $('.spinner .btn:last-of-type').on('click', function () {
          $('.spinner input').val(parseInt($('.spinner input').val(), 10) - 1);
        });
      });

      var OpenFrame;

      //#region 图表部分

      //加载屏幕配置信息
      function LoadScreen(screenData) {

        $("#VisualTitle").text(decodeURI(screenData.IsoScreen.Title));

        //var imgFile = "linear-gradient(to right,rgba(0,0,0,0.6) 20%,rgba(0,0,0,0) 40%,rgba(0,0,0,0) 60%,rgba(0,0,0,0.6) 80%), url(" + decodeURI(screenData.IsoScreen.PicPath) + ")";

        //$("#bg").css("background-image", imgFile.replace("\\", "\/"));

        for (var i = 0; i < screenData.IsoScreen.IsoCharts.length; i++) {
          var chart = screenData.IsoScreen.IsoCharts[i];
          var fType = decodeURI(screenData.IsoScreen.FrameType);
          if (chart.ReaderID == 0) {
            ChartCreate(chart, fType);
          }
          else {
            ChartSave(chart, fType);
          }
        }
        //console.log("加载屏幕配置：");
        //console.log(screenData);
      }

      //计算不同列的图表位置，争取左右对称和居中
      function CaloLeft(index, width) {
        var column = parseInt((index - 1) / 4);

        var nColumn = column;
        switch (column) {
          //case 0: nColumn = 0; break;
          case 0: nColumn = 0; break;
          case 1: nColumn = 4; break;
          case 2: nColumn = 1; break;
          case 3: nColumn = 5; break;
          case 4: nColumn = 2; break;
          case 5: nColumn = 6; break;
          case 6: nColumn = 3; break;
        }

        var left = 0;
        switch (nColumn) {
          case 0:
          case 1:
          case 2:
            left = nColumn * width + 20 + bLeft;
            break;
          case 3:
            left = 0; //(bWidth - width) / 2 + bLeft;
            break;
          case 4:
          case 5:
          case 6:
            left = (4 - nColumn) * width - 20 - bLeft; //(bWidth + bLeft) - ((nColumn - 3) * width);
            break;
        }

        return left;
      }

      var ThemeID = 1;

      $("#BackColorTransparent").click(function () { OpenTheme(ThemeID); });

      //数据表
      function ShowTable() { }
      //折线图
      function ShowLine() {

        var option = {
          title: {
            text: '用电',
          },
          tooltip: {
            trigger: 'axis',
            axisPointer: {
              type: 'cross'
            }
          },
          toolbox: {
            show: true,
            feature: {
              saveAsImage: {}
            }
          },
          xAxis: {
            type: 'category',
            boundaryGap: false,
            // prettier-ignore
            data: ['00:00', '01:15', '02:30', '03:45', '05:00', '06:15', '07:30', '08:45', '10:00', '11:15', '12:30', '13:45', '15:00', '16:15', '17:30', '18:45', '20:00', '21:15', '22:30', '23:45']
          },
          yAxis: {
            type: 'value',
            axisLabel: {
              formatter: '{value} W'
            },
            axisPointer: {
              snap: true
            }
          },
          visualMap: {
            show: false,
            dimension: 0,
            pieces: [
              {
                lte: 6,
                color: 'green'
              },
              {
                gt: 6,
                lte: 8,
                color: 'red'
              },
              {
                gt: 8,
                lte: 14,
                color: 'green'
              },
              {
                gt: 14,
                lte: 17,
                color: 'red'
              },
              {
                gt: 17,
                color: 'green'
              }
            ]
          },
          series: [
            {
              name: '功耗',
              type: 'line',
              smooth: true,
              // prettier-ignore
              data: [300, 280, 250, 260, 270, 300, 550, 500, 400, 390, 380, 390, 400, 500, 600, 750, 800, 700, 600, 400],
              markArea: {
                itemStyle: {
                  color: 'rgba(255, 173, 177, 0.4)'
                },
                data: [
                  [
                    {
                      name: '早高峰',
                      xAxis: '07:30'
                    },
                    {
                      xAxis: '10:00'
                    }
                  ],
                  [
                    {
                      name: '晚高峰',
                      xAxis: '17:30'
                    },
                    {
                      xAxis: '21:15'
                    }
                  ]
                ]
              }
            }
          ]
        };

        return option;
      }
      //柱状图
      function ShowBar() {
        var option = {
          tooltip: {
            trigger: 'axis',
            axisPointer: {
              // Use axis to trigger tooltip
              type: 'shadow' // 'shadow' as default; can also be 'line' or 'shadow'
            }
          },
          legend: {},
          grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
          },
          xAxis: {
            type: 'value'
          },
          yAxis: {
            type: 'category',
            data: ['周一', '周二', '周三', '周四', '周五', '周六', '周日']
          },
          series: [
            {
              name: '目录',
              type: 'bar',
              stack: 'total',
              label: {
                show: true
              },
              emphasis: {
                focus: 'series'
              },
              data: [320, 302, 301, 334, 390, 330, 320]
            },
            {
              name: '任务',
              type: 'bar',
              stack: 'total',
              label: {
                show: true
              },
              emphasis: {
                focus: 'series'
              },
              data: [120, 132, 101, 134, 90, 230, 210]
            },
            {
              name: '台帐',
              type: 'bar',
              stack: 'total',
              label: {
                show: true
              },
              emphasis: {
                focus: 'series'
              },
              data: [220, 182, 191, 234, 290, 330, 310]
            },
            {
              name: '视频',
              type: 'bar',
              stack: 'total',
              label: {
                show: true
              },
              emphasis: {
                focus: 'series'
              },
              data: [150, 212, 201, 154, 190, 330, 410]
            },
            {
              name: '搜索',
              type: 'bar',
              stack: 'total',
              label: {
                show: true
              },
              emphasis: {
                focus: 'series'
              },
              data: [820, 832, 901, 934, 1290, 1330, 1320]
            }
          ]
        };

        return option;
      }
      //饼状图
      function ShowPie() {
        var option = {
          title: {
            text: '网站访问',
            left: 'center'
          },
          tooltip: {
            trigger: 'item'
          },
          legend: {
            orient: 'vertical',
            left: 'left'
          },
          series: [
            {
              name: '统计',
              type: 'pie',
              radius: '50%',
              data: [
                { value: 1048, name: '搜索' },
                { value: 735, name: '目录' },
                { value: 580, name: '任务' },
                { value: 484, name: '台帐' },
                { value: 300, name: '视频' }
              ],
              emphasis: {
                itemStyle: {
                  shadowBlur: 10,
                  shadowOffsetX: 0,
                  shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
              }
            }
          ]
        };

        return option;
      }
      //环形图
      function ShowRing() {
        var option = {
          tooltip: {
            trigger: 'item'
          },
          legend: {
            top: '5%',
            left: 'center'
          },
          series: [
            {
              name: '统计',
              type: 'pie',
              radius: ['40%', '70%'],
              avoidLabelOverlap: false,
              itemStyle: {
                borderRadius: 10,
                borderColor: '#fff',
                borderWidth: 2
              },
              label: {
                show: false,
                position: 'center'
              },
              emphasis: {
                label: {
                  show: true,
                  fontSize: '40',
                  fontWeight: 'bold'
                }
              },
              labelLine: {
                show: false
              },
              data: [
                { value: 1048, name: '搜索' },
                { value: 735, name: '目录' },
                { value: 580, name: '任务' },
                { value: 484, name: '台帐' },
                { value: 300, name: '视频' }
              ]
            }
          ]
        };

        return option;
      }
      //面积图
      function ShowArea() {
        var option = {
          title: {
            text: '堆叠'
          },
          tooltip: {
            trigger: 'axis',
            axisPointer: {
              type: 'cross',
              label: {
                backgroundColor: '#6a7985'
              }
            }
          },
          legend: {
            data: ['任务', '台帐', '视频', '目录', '搜索']
          },
          toolbox: {
            feature: {
              saveAsImage: {}
            }
          },
          grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
          },
          xAxis: [
            {
              type: 'category',
              boundaryGap: false,
              data: ['周一', '周二', '周三', '周四', '周五', '周六', '周日']
            }
          ],
          yAxis: [
            {
              type: 'value'
            }
          ],
          series: [
            {
              name: '任务',
              type: 'line',
              stack: 'Total',
              areaStyle: {},
              emphasis: {
                focus: 'series'
              },
              data: [120, 132, 101, 134, 90, 230, 210]
            },
            {
              name: '台帐',
              type: 'line',
              stack: 'Total',
              areaStyle: {},
              emphasis: {
                focus: 'series'
              },
              data: [220, 182, 191, 234, 290, 330, 310]
            },
            {
              name: '视频',
              type: 'line',
              stack: 'Total',
              areaStyle: {},
              emphasis: {
                focus: 'series'
              },
              data: [150, 232, 201, 154, 190, 330, 410]
            },
            {
              name: '目录',
              type: 'line',
              stack: 'Total',
              areaStyle: {},
              emphasis: {
                focus: 'series'
              },
              data: [320, 332, 301, 334, 390, 330, 320]
            },
            {
              name: '搜索',
              type: 'line',
              stack: 'Total',
              label: {
                show: true,
                position: 'top'
              },
              areaStyle: {},
              emphasis: {
                focus: 'series'
              },
              data: [820, 932, 901, 934, 1290, 1330, 1320]
            }
          ]
        };

        return option;
      }
      //雷达图
      function ShowRadar() {
        var option = {
          title: {
            text: '能力雷达'
          },
          legend: {
            data: ['目标', '实际']
          },
          radar: {
            // shape: 'circle',
            indicator: [
              { name: '产品', max: 6500 },
              { name: '管理', max: 16000 },
              { name: '技术', max: 30000 },
              { name: '服务', max: 38000 },
              { name: '成长', max: 52000 },
              { name: '营销', max: 25000 }
            ]
          },
          series: [
            {
              name: 'Budget vs spending',
              type: 'radar',
              data: [
                {
                  value: [4200, 3000, 20000, 35000, 50000, 18000],
                  name: 'Allocated Budget'
                },
                {
                  value: [5000, 14000, 28000, 26000, 42000, 21000],
                  name: 'Actual Spending'
                }
              ]
            }
          ]
        };

        return option;
      }
      //数据集
      function ShowNumber() { }
      //超文本
      function ShowHtml() { }
      //默认
      function SetChart() {
        var option = {
          tooltip: {
            trigger: 'axis',
            axisPointer: {
              // Use axis to trigger tooltip
              type: 'shadow' // 'shadow' as default; can also be 'line' or 'shadow'
            }
          },
          legend: {},
          grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
          },
          xAxis: {
            type: 'value'
          },
          yAxis: {
            type: 'category',
            data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
          },
          series: [
            {
              name: 'Direct',
              type: 'bar',
              stack: 'total',
              label: {
                show: true
              },
              emphasis: {
                focus: 'series'
              },
              data: [320, 302, 301, 334, 390, 330, 320]
            },
            {
              name: 'Mail Ad',
              type: 'bar',
              stack: 'total',
              label: {
                show: true
              },
              emphasis: {
                focus: 'series'
              },
              data: [120, 132, 101, 134, 90, 230, 210]
            },
            {
              name: 'Affiliate Ad',
              type: 'bar',
              stack: 'total',
              label: {
                show: true
              },
              emphasis: {
                focus: 'series'
              },
              data: [220, 182, 191, 234, 290, 330, 310]
            },
            {
              name: 'Video Ad',
              type: 'bar',
              stack: 'total',
              label: {
                show: true
              },
              emphasis: {
                focus: 'series'
              },
              data: [150, 212, 201, 154, 190, 330, 410]
            },
            {
              name: 'Search Engine',
              type: 'bar',
              stack: 'total',
              label: {
                show: true
              },
              emphasis: {
                focus: 'series'
              },
              data: [820, 832, 901, 934, 1290, 1330, 1320]
            }
          ]
        };

        return option;
      }

      //新增图表需求
      function ChartCreate(chart, fType) {
        if (boxIndex >= BoxCount) {
          alert("已超出最大数量，无法继续添加"); return;
        }

        BoxArray.push(0);

        boxIndex++;

        var pw = 300;
        var ph = 220;
        var pl = 100;
        var pt = 100;

        var vw = $(window).width();
        var vh = $(window).height();

        if (chart != null) {
          pw = chart.W;
          ph = chart.H;
          //pt = chart.T;
          //pl = chart.L;

          pt = parseInt(vh) / 2 + parseInt(chart.T) - parseInt(chart.H) + 260;
          pl = parseInt(vw) / 2 + parseInt(chart.L) - parseInt(chart.W) + 100;
        }

        var fbox = document.createElement('div');
        fbox.classList = "custom-drag-control divbox " + fType;
        fbox.id = "box" + boxIndex;
        fbox.index = boxIndex;

        //console.log(fbox.className);

        var box = document.createElement('div');
        box.className = "inbox";
        //box.style.backgroundColor = "#aaaaaa";

        fbox.style.width = pw + "px";
        box.style.width = (pw - 40) + "px";
        fbox.style.height = ph + "px";
        box.style.height = (ph - 20) + "px";

        //fbox.style["transform"] = 'translate(' + pl + 'px, ' + pt + 'px)';
        fbox.style.left = pl + "px";
        fbox.style.top = pt + "px";


        fbox.appendChild(box);

        $("#bg").append(fbox);

        var ThemeID = 1;
        ThemeID = chart.ThemeID;

        var themes = ['vintage', 'dark', 'westeros', 'essos', 'wonderland', 'walden', 'chalk', 'infographic', 'macarons', 'roma', 'shine', 'purple-passion'];
        var lineChart = echarts.init(box, themes[ThemeID]);
        var lineoption;

        if (chart != null) {
          switch (parseInt(chart.ChartType)) {
            case 0: //原表格
              lineoption = ShowTable();
              break;
            case 1: //折线图
              lineoption = ShowLine();
              break;
            case 2: //柱状图
              lineoption = ShowBar();
              break;
            case 3: //饼状图
              lineoption = ShowPie();
              break;
            case 4: //环形图
              lineoption = ShowRing();
              break;
            case 5: //面积图
              lineoption = ShowArea();
              break;
            case 6: //雷达图
              lineoption = ShowRadar();
              break;
            case 7: //值标签

              break;
            case 8: //数据集

              break;
            case 9: //超文本

              break;
            default:

          }
        }
        else {
          lineoption = SetChart();
        }

        lineoption.backgroundColor = "transparent";

        lineChart.setOption(lineoption);
      }

      //数据表

      //折线图
      function DrawLine(json) {
        var lineoption = {
          title: {
            text: '部门资源'
          },
          tooltip: {
            trigger: 'axis'
          },
          legend: {
            data: json.legendData
          },
          grid: {
            x: 40,
            x2: 40,
            y2: 24
          },
          calculable: true,
          xAxis: [
            {
              type: 'category',
              boundaryGap: false,
              data: json.xAxisData
            }
          ],
          yAxis: [
            {
              type: 'value',
              axisLabel: {
                formatter: '{value}'
              }
            }
          ],
          series: json.series
        };

        for (var i = 0; i < lineoption.series.length; i++) {
          lineoption.series[i].type = 'line';
        }
        //if ($("#BackColorTransparent").is(":checked")) {
        //  lineoption.backgroundColor = "transparent";
        //}
        //加载数据图表
        //lineChart.setOption(lineoption);
        //$(window).resize(lineChart.resize);
        return lineoption;
      }
      //柱状图
      function DrawBar(json) {
        var lineoption = {
          title: {
            text: '部门资源'
          },
          tooltip: {
            trigger: 'axis'
          },
          legend: {
            data: json.legendData
          },
          calculable: true,
          xAxis: [
            {
              type: 'category',
              boundaryGap: false,
              data: json.xAxisData
            }
          ],
          yAxis: [
            {
              type: 'value',
              axisLabel: {
                formatter: '{value}'
              }
            }
          ],
          series: json.series
        };

        //加载数据图表

        //for (var i = 0; i < lineoption.series.length; i++) {
        //  lineoption.series[i].type = 'bar';
        //}
        //if ($("#BackColorTransparent").is(":checked")) {
        //  lineoption.backgroundColor = "transparent";
        //}
        //lineChart.setOption(lineoption);
        //$(window).resize(lineChart.resize);
        return lineoption;
      }
      //饼状图
      function DrawPie(json) {
        var lineoption = {
          title: {
            text: '部门资源'
          },
          tooltip: {
            trigger: 'item'
          },
          series: [
            {
              name: '占比',
              type: 'pie',
              radius: '50%',
              emphasis: {
                itemStyle: {
                  shadowBlur: 10,
                  shadowOffsetX: 0,
                  shadowColor: 'rgba(0, 0, 0, 0.5)'
                }
              },
              data: json.seriesDate
            }
          ]
        };

        //加载数据图表

        //for (var i = 0; i < lineoption.series.length; i++) {
        //  lineoption.series[i].type = 'pie';
        //}
        //if ($("#BackColorTransparent").is(":checked")) {
        //  lineoption.backgroundColor = "transparent";
        //}
        //lineChart.setOption(lineoption);
        //$(window).resize(lineChart.resize);
        return lineoption;
      }
      //环形图
      function DrawRing(json) {
        var lineoption = {
          title: {
            text: '部门资源'
          },
          tooltip: {
            trigger: 'item'
          },
          series: [
            {
              name: '占比',
              type: 'pie',
              radius: ['40%', '70%'],
              avoidLabelOverlap: false,
              itemStyle: {
                borderRadius: 10,
                borderColor: '#fff',
                borderWidth: 2
              },
              label: {
                show: false,
                position: 'center'
              },
              emphasis: {
                label: {
                  show: true,
                  fontSize: '40',
                  fontWeight: 'bold'
                }
              },
              labelLine: {
                show: false
              },
              data: json.seriesDate
            }
          ]
        };

        //加载数据图表

        //for (var i = 0; i < lineoption.series.length; i++) {
        //  lineoption.series[i].type = 'pie';
        //}
        //if ($("#BackColorTransparent").is(":checked")) {
        //  lineoption.backgroundColor = "transparent";
        //}
        //lineChart.setOption(lineoption);
        //$(window).resize(lineChart.resize);
        return lineoption;
      }
      //面积图
      function DrawArea(json) {
        var lineoption = {
          title: {
            text: '部门资源'
          },
          tooltip: {
            trigger: 'axis',
            axisPointer: {
              type: 'cross',
              label: {
                backgroundColor: '#6a7985'
              }
            }
          },
          legend: {
            data: json.legendData
          },
          grid: {
            left: '3%',
            right: '4%',
            bottom: '3%',
            containLabel: true
          },
          xAxis: [
            {
              type: 'category',
              boundaryGap: false,
              data: json.xAxisData,
              axisLabel: {
                interval: 0,
                rotate: 30
              }
            }
          ],
          yAxis: [
            {
              type: 'value'
            }
          ],
          series: json.series
        };

        for (var i = 0; i < lineoption.series.length; i++) {
          lineoption.series[i].type = 'line';
          lineoption.series[i].stack = 'Total';
          lineoption.series[i].areaStyle = {};
        };

        //加载数据图表
        //console.log(echarts.version);
        //if ($("#BackColorTransparent").is(":checked")) {
        //  lineoption.backgroundColor = "transparent";
        //}
        //lineChart.setOption(lineoption);
        //$(window).resize(lineChart.resize);
        return lineoption;
      }
      //雷达图
      function DrawRadar(json) {
        var lineoption = {
          title: {
            text: '部门资源',
            subtext: '纯属虚构'
          },
          tooltip: {
            trigger: 'axis'
          },
          legend: {
            orient: 'vertical',
            x: 'right',
            y: 'bottom',
            data: json.legendData
          },
          polar: [
            {
              indicator: json.indicator
            }
          ],
          calculable: true,
          series: [
            {
              name: '部门资源',
              type: 'radar',
              data: json.radarData
            }
          ]
        };



        //{
        //  title: {
        //    text: '部门资源'
        //  },
        //  legend: {
        //    data: json.legendData
        //  },
        //  radar: {
        //    indicator: json.indicator
        //  },
        //  series: [
        //    {
        //      name: '部门资源',
        //      type: 'radar',
        //      data: json.radarData
        //    }
        //  ]
        //};

        //加载数据图表
        //console.log(json.radarData);
        //if ($("#BackColorTransparent").is(":checked")) {
        //  lineoption.backgroundColor = "transparent";
        //}
        //lineChart.setOption();
        //$(window).resize(lineChart.resize);
        return lineoption;
      }
      //值标签

      //数据集

      //超文本

      //默认

      //插入已有图表
      function ChartSave(chart, fType) {
        if (boxIndex >= BoxCount) {
          alert("已超出最大数量，无法继续添加"); return;
        }

        if (chart != null) {
          BoxArray.push(chart.ReaderID);
        }
        else {
          BoxArray.push(readerID);
        }

        boxIndex++;

        var pw = 300;
        var ph = 220;
        var pl = 100;
        var pt = 100;

        var vw = $(window).width();
        var vh = $(window).height();

        if (chart != null) {
          pw = chart.W;
          ph = chart.H;
          //pt = chart.T;
          //pl = chart.L;

          pt = parseInt(vh) / 2 + parseInt(chart.T) - parseInt(chart.H) + 260;
          pl = parseInt(vw) / 2 + parseInt(chart.L) - parseInt(chart.W) + 100;
        }

        var fbox = document.createElement('div');
        fbox.classList = "custom-drag-control divbox " + fType;
        fbox.id = "box" + boxIndex;
        fbox.index = boxIndex;

        var box = document.createElement('div');
        box.className = "inbox";
        //box.style.backgroundColor = "#aaaaaa";

        fbox.style.width = pw + "px";
        box.style.width = (pw - 40) + "px";
        fbox.style.height = ph + "px";
        box.style.height = (ph - 20) + "px";

        //fbox.style["transform"] = 'translate(' + pl + 'px, ' + pt + 'px)';
        fbox.style.left = pl + "px";
        fbox.style.top = pt + "px";

        fbox.appendChild(box);

        $("#bg").append(fbox);

        var json = jh.LoadJsonAsync("/Service/IsoReaders.asmx/LoadIsoReaderJson", { "readerID": chart.ReaderID });

        console.log(json);

        var ThemeID = 0;
        ThemeID = chart.ThemeID;
        //box.removeAttribute("_echarts_instance_");
        var themes = ['', 'vintage', 'dark', 'westeros', 'essos', 'wonderland', 'walden', 'chalk', 'infographic', 'macarons', 'roma', 'shine', 'purple-passion'];
        var lineChart = echarts.init(box, themes[ThemeID]);
        var lineoption;

        if (chart != null) {
          switch (parseInt(chart.ChartType)) {
            case 0: //原表格
              //lineoption = DrawTable(json);
              break;
            case 1: //折线图
              lineoption = DrawLine(json);
              break;
            case 2: //柱状图
              lineoption = DrawBar(json);
              break;
            case 3: //饼状图
              lineoption = DrawPie(json);
              break;
            case 4: //环形图
              lineoption = DrawRing(json);
              break;
            case 5: //面积图
              lineoption = DrawArea(json);
              break;
            case 6: //雷达图
              lineoption = DrawRadar(json);
              break;
            case 7: //值标签

              break;
            case 8: //数据集

              break;
            case 9: //超文本

              break;
            default:

          }
        }
        else {
          lineoption = SetChart();
        }

        lineoption.backgroundColor = "transparent";

        console.log(lineoption);

        lineChart.setOption(lineoption);

      }

      //计算图表类型
      function ChartTypeStr(chartType) {
        var str = "";
        switch (chartType) {
          case 0: str = "原表格"; break;
          case 1: str = "折线图"; break;
          case 2: str = "柱状图"; break;
          case 3: str = "饼状图"; break;
          case 4: str = "环形图"; break;
          case 5: str = "面积图"; break;
          case 6: str = "进度条"; break;
          case 7: str = "值标签"; break;
          case 8: str = "超文本"; break;
        }
        return str;
      }
      //#endregion

      //#region 窗体尺寸变化
      $(window).resize(function () { WindowReSize(); });

      //窗体尺寸变化，调整画板
      function WindowReSize() {

        //当窗体尺寸变化后，第一时间应当调整镜头的宽高比，以保证模型不失真变形
        camera.aspect = (window.innerWidth - leftWidth - rightWidth) / (window.innerHeight - bottomHeight);
        //宽高比变化后，镜头必须重新计算投影矩阵值
        camera.updateProjectionMatrix();

        //renderer.setSize(window.innerWidth - leftWidth - rightWidth, window.innerHeight - bottomHeight);
        //效果器重算
        effect.setSize(window.innerWidth - leftWidth - rightWidth, window.innerHeight - bottomHeight);

        var wWidth = $(window).width();
        var wHeight = $(window).height();

        bWidth = wWidth - 20;
        bHeight = wHeight - 20;

        bLeft = 10;
        bTop = 10;

        if (bWidth / bHeight > 1920 / 1080) {
          //宽度超出

          bWidth = Math.round(bHeight * (1920 / 1080));
          bLeft = (wWidth - bWidth) / 2;
        }
        else {
          //高度超出
          bHeight = Math.round(bWidth / (1920 / 1080));
        }

        $("#bg").width(bWidth);

        $("#bg").css("left", '0px');
        $("#bg").css("top", '0px');
      }
      //#endregion

      //#region 纹理贴图

      //弹出纹理贴图选择对话框
      $('#SelectMap1Btn').click(function () {
        OpenFrame = layer.open({
          type: 2,
          title: '选择贴图',
          shadeClose: true,
          shade: [0.8, '#393D49'],
          maxmin: true,
          area: ['998px', '650px'],
          content: '../MapSelect.aspx'
        });
      });

      //纹理贴图选择完毕
      function MapSelect(name, mapFile) {
        layer.close(OpenFrame);
        FrameType = name;

        $("#TextureTxt").val(mapFile)
        console.log(mapFile);
        var mapObj = new THREE.TextureLoader().load(mapFile);
        mapObj.wrapS = THREE.RepeatWrapping;
        mapObj.wrapT = THREE.RepeatWrapping;
        mapObj.repeat.set(0.05, 0.05);

        var parameters = { transparent: false, opactity: 1, color: 0xCCCCCC, shininess: 10 };

        var mate = new THREE.MeshLambertMaterial(parameters);
        mate.metalness = 1.0;
        mate.roughness = 0.6;
        mate.map = mapObj;
        //mate.map.encoding = THREE.sRGBEncoding;
        mate.map.needsUpdate = true;
        MouseSelectMesh.material = mate;
        //MouseSelectMesh.receiveShadow = true;

        console.log(MouseSelectMesh);
      }
      //#endregion

      //允许外部弹窗调用纹理选择
      window.MapSelect = MapSelect;

    </script>

  </form>
</body>
</html>
